<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi cuenta ¬∑ CUBAZON</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f0f2f5;
            color: #0f1111;
            line-height: 1.5;
        }
        
        .account-container {
            max-width: 1500px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        .account-header {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .account-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .account-title i {
            font-size: 32px;
            color: #f08804;
        }
        
        .account-title h1 {
            font-size: 28px;
            font-weight: 700;
            color: #0f1111;
        }
        
        /* ===== ACCIONES R√ÅPIDAS ===== */
        .quick-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .quick-action-card {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
            border: 2px solid transparent;
            cursor: pointer;
            text-decoration: none;
            color: #0f1111;
        }
        
        .quick-action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #f08804;
        }
        
        .quick-action-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }
        
        .quick-action-icon.transfer {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .quick-action-icon.receive {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .quick-action-icon.pay {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .quick-action-content h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .quick-action-content p {
            color: #6c757d;
            font-size: 14px;
        }
        
        /* ===== SALDO EN CUP ===== */
        .balance-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .balance-icon {
            width: 70px;
            height: 70px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }
        
        .balance-info h3 {
            font-size: 16px;
            font-weight: 400;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .balance-amount {
            font-size: 36px;
            font-weight: 700;
        }
        
        .balance-amount small {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.8;
            margin-left: 5px;
        }
        
        .balance-actions {
            display: flex;
            gap: 15px;
            margin-left: auto;
        }
        
        .btn-balance {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-balance:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .account-grid {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 30px;
        }
        
        .account-sidebar {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            height: fit-content;
        }
        
        .user-info {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        
        .user-avatar {
            width: 100px;
            height: 100px;
            background: #232f3e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
        }
        
        .user-avatar i {
            font-size: 50px;
            color: white;
        }
        
        .user-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .user-email {
            color: #6c757d;
            font-size: 14px;
        }
        
        .account-menu {
            list-style: none;
        }
        
        .account-menu li {
            margin-bottom: 5px;
        }
        
        .account-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: #0f1111;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .account-menu a:hover {
            background: #f0f2f5;
        }
        
        .account-menu a.active {
            background: #fff6e5;
            color: #f08804;
            font-weight: 600;
        }
        
        .account-menu i {
            width: 20px;
            text-align: center;
        }
        
        .account-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .section-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f2f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .profile-form {
            max-width: 600px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #0f1111;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: #f08804;
            outline: none;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #ffd814;
            color: #0f1111;
        }
        
        .btn-primary:hover {
            background: #f7ca00;
        }
        
        .btn-secondary {
            background: #f0f2f5;
            color: #0f1111;
        }
        
        .btn-secondary:hover {
            background: #e3e6e9;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        /* ===== PEDIDOS MEJORADOS ===== */
        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .order-card {
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s;
            background: white;
        }
        
        .order-card:hover {
            border-color: #f08804;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .order-id {
            font-family: monospace;
            font-size: 18px;
            font-weight: 700;
            color: #009644;
        }
        
        .order-date {
            color: #6c757d;
            font-size: 14px;
        }
        
        .order-status {
            padding: 6px 15px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pendiente {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-enviado {
            background: #cce5ff;
            color: #004085;
        }
        
        .status-entregado {
            background: #d4edda;
            color: #155724;
        }
        
        .status-cancelado {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* ===== BARRA DE PROGRESO ===== */
        .order-progress {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin-bottom: 10px;
        }
        
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
            background: #f8f9fa;
            padding: 0 10px;
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            margin-bottom: 5px;
            transition: all 0.3s;
        }
        
        .step-icon.completed {
            background: #009644;
            border-color: #009644;
            color: white;
        }
        
        .step-icon.active {
            border-color: #f08804;
            color: #f08804;
        }
        
        .step-label {
            font-size: 12px;
            font-weight: 600;
            color: #6c757d;
        }
        
        .step-label.completed {
            color: #009644;
        }
        
        .step-label.active {
            color: #f08804;
        }
        
        .progress-bar-bg {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #dee2e6;
            z-index: 1;
        }
        
        .progress-bar-fill {
            height: 2px;
            background: #009644;
            transition: width 0.3s ease;
        }
        
        /* ===== DETALLE DE PRODUCTOS EN PEDIDO ===== */
        .order-products {
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .order-product-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .order-product-item:last-child {
            border-bottom: none;
        }
        
        .order-product-image {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            padding: 5px;
        }
        
        .order-product-details {
            flex: 1;
        }
        
        .order-product-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .order-product-price {
            color: #b12704;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .order-product-specs {
            font-size: 13px;
            color: #6c757d;
        }
        
        .order-product-subtotal {
            font-weight: 700;
            color: #b12704;
            min-width: 100px;
            text-align: right;
        }
        
        /* ===== RESUMEN DE PAGO ===== */
        .order-summary {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }
        
        .summary-row.total {
            font-size: 20px;
            font-weight: 700;
            color: #b12704;
            border-top: 2px solid #dee2e6;
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .summary-label {
            color: #6c757d;
        }
        
        .summary-value {
            font-weight: 600;
        }
        
        .summary-value.discount {
            color: #059669;
        }
        
        /* ===== MODAL DE DETALLE ===== */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            width: 90%;
            max-width: 800px;
            border-radius: 12px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            animation: modalFadeIn 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 25px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 24px;
        }
        
        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: #6c757d;
        }
        
        .close-modal:hover {
            color: #0f1111;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .address-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            position: relative;
            margin-bottom: 15px;
        }
        
        .address-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f08804;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .address-name {
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .address-details {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .address-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }
        
        .loading i {
            font-size: 48px;
            color: #009644;
            margin-bottom: 20px;
        }
        
        @media (max-width: 1024px) {
            .account-grid {
                grid-template-columns: 1fr;
            }
            .quick-actions {
                flex-direction: column;
            }
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .order-product-item {
                flex-wrap: wrap;
            }
            .order-product-subtotal {
                text-align: left;
                margin-left: 95px;
            }
            .address-actions {
                flex-direction: column;
            }
            .address-actions .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="account-container">
        <div id="loadingContainer" class="loading" style="display: none;">
            <i class="fa fa-spinner fa-pulse"></i>
            <h2>Cargando tu cuenta...</h2>
        </div>
        
        <div id="accountContent" style="display: none;"></div>
    </div>
    
    <!-- MODAL: Detalle de Pedido -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa fa-shopping-bag"></i> Detalle del Pedido</h2>
                <span class="close-modal" onclick="window.cerrarModal()">&times;</span>
            </div>
            <div class="modal-body" id="orderModalBody">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script type="module">
        import { supabase } from '/js/supabase-client.js'
        import { auth } from '/js/auth.js'
        import { initCarrito } from '/js/cart.js'
        
        const carrito = initCarrito()
        window.cart = carrito
        carrito.cargarDeLocalStorage()
        carrito.actualizarInterfaz()
        
        let seccionActual = 'perfil'
        let pedidos = []
        let direcciones = []
        
        // ========== VERIFICAR AUTENTICACI√ìN CON ESPERA ==========
        async function verificarAutenticacion() {
            console.log('üîç Verificando autenticaci√≥n...')
            
            for (let i = 0; i < 10; i++) {
                if (auth.isAuthenticated()) {
                    console.log('‚úÖ Usuario autenticado:', auth.getUsuario()?.email)
                    return true
                }
                console.log('‚è≥ Esperando inicializaci√≥n...', i + 1)
                await new Promise(resolve => setTimeout(resolve, 200))
            }
            
            console.log('‚ùå No autenticado, redirigiendo...')
            window.location.href = '/login.html'
            return false
        }
        
        await verificarAutenticacion()
        
        // ========== FUNCIONES DE SALDO ==========
        window.recargarSaldo = async function() {
            const usuario = auth.getUsuario();
            
            const { value: formValues } = await Swal.fire({
                title: 'Solicitar recarga de saldo',
                html: `
                    <p style="margin-bottom: 20px;">¬øCu√°nto deseas recargar?</p>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('monto-recarga').value=100">$100</button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('monto-recarga').value=500">$500</button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('monto-recarga').value=1000">$1000</button>
                    </div>
                    <input type="number" id="monto-recarga" class="swal2-input" placeholder="Monto personalizado" min="10" step="0.01" required>
                    <select id="metodo-pago" class="swal2-input">
                        <option value="efectivo">üí∞ Efectivo</option>
                        <option value="transferencia">üì± Transferencia m√≥vil</option>
                        <option value="tarjeta">üí≥ Tarjeta bancaria</option>
                    </select>
                    <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                        <i class="fa fa-info-circle"></i> Tu solicitud ser√° revisada por un administrador.
                    </p>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Solicitar recarga',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const monto = document.getElementById('monto-recarga').value;
                    const metodo = document.getElementById('metodo-pago').value;
                    if (!monto || monto < 10) {
                        Swal.showValidationMessage('El monto m√≠nimo es $10');
                        return false;
                    }
                    return { monto: parseFloat(monto), metodo };
                }
            });
            
            if (formValues) {
                try {
                    const { error } = await supabase
                        .from('solicitudes_recarga')
                        .insert({
                            user_id: usuario.id,
                            monto: formValues.monto,
                            metodo_pago: formValues.metodo,
                            estado: 'pendiente'
                        });
                    
                    if (error) throw error;
                    
                    Swal.fire({
                        icon: 'success',
                        title: '¬°Solicitud enviada!',
                        text: 'Recibir√°s una notificaci√≥n cuando sea aprobada',
                        timer: 3000
                    });
                } catch (error) {
                    console.error('Error al crear solicitud:', error);
                    Swal.fire('Error', 'No se pudo crear la solicitud', 'error');
                }
            }
        };
        
        window.historialSaldo = async function() {
            const usuario = auth.getUsuario();
            
            try {
                const { data, error } = await supabase
                    .from('historial_saldo')
                    .select('*')
                    .eq('user_id', usuario.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'Sin movimientos',
                        text: 'A√∫n no tienes movimientos de saldo',
                        confirmButtonText: 'Entendido'
                    });
                    return;
                }
                
                let html = '<div style="max-height: 400px; overflow-y: auto;">';
                html += '<table style="width:100%; border-collapse:collapse;">';
                html += '<tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Saldo</th></tr>';
                
                data.forEach(h => {
                    const fecha = new Date(h.created_at).toLocaleDateString('es-ES');
                    const signo = h.tipo === 'compra' ? '-' : '+';
                    const color = h.tipo === 'compra' ? '#dc3545' : '#28a745';
                    
                    html += `<tr style="border-bottom:1px solid #dee2e6;">`;
                    html += `<td style="padding:10px;">${fecha}</td>`;
                    html += `<td style="padding:10px;">${h.tipo}</td>`;
                    html += `<td style="padding:10px; color: ${color}; font-weight:600;">${signo}$${Math.abs(h.monto).toFixed(2)}</td>`;
                    html += `<td style="padding:10px; font-weight:600;">$${h.saldo_nuevo.toFixed(2)}</td>`;
                    html += `</tr>`;
                });
                
                html += '</table></div>';
                
                Swal.fire({
                    title: 'Historial de saldo',
                    html: html,
                    width: '600px',
                    confirmButtonText: 'Cerrar'
                });
                
            } catch (error) {
                console.error('Error cargando historial:', error);
                Swal.fire('Error', 'No se pudo cargar el historial', 'error');
            }
        };
        
        // ========== HISTORIAL DE TRANSFERENCIAS ==========
        window.historialTransferencias = async function() {
            const usuario = auth.getUsuario();
            
            try {
                const { data, error } = await supabase
                    .from('transferencias_saldo')
                    .select(`
                        *,
                        emisor:auth_users_view!emisor_id(email, nombre_completo),
                        receptor:auth_users_view!receptor_id(email, nombre_completo)
                    `)
                    .or(`emisor_id.eq.${usuario.id},receptor_id.eq.${usuario.id}`)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'Sin transferencias',
                        text: 'A√∫n no has realizado ni recibido transferencias',
                        confirmButtonText: 'Entendido'
                    });
                    return;
                }
                
                let html = '<div style="max-height: 400px; overflow-y: auto;">';
                html += '<table style="width:100%; border-collapse:collapse;">';
                html += '<tr><th>Fecha</th><th>Tipo</th><th>Contacto</th><th>Monto</th><th>Concepto</th></tr>';
                
                data.forEach(t => {
                    const fecha = new Date(t.created_at).toLocaleDateString('es-ES');
                    const esEmisor = t.emisor_id === usuario.id;
                    
                    const tipo = esEmisor ? 'Enviado' : 'Recibido';
                    const contacto = esEmisor ? t.receptor?.email : t.emisor?.email;
                    const signo = esEmisor ? '-' : '+';
                    const color = esEmisor ? '#dc3545' : '#28a745';
                    
                    html += `<tr style="border-bottom:1px solid #dee2e6;">`;
                    html += `<td style="padding:10px;">${fecha}</td>`;
                    html += `<td style="padding:10px;">${tipo}</td>`;
                    html += `<td style="padding:10px;">${contacto || 'N/A'}</td>`;
                    html += `<td style="padding:10px; color: ${color}; font-weight:600;">${signo}$${t.monto.toFixed(2)}</td>`;
                    html += `<td style="padding:10px;">${t.concepto || '‚Äî'}</td>`;
                    html += `</tr>`;
                });
                
                html += '</table></div>';
                
                Swal.fire({
                    title: 'Historial de transferencias',
                    html: html,
                    width: '800px',
                    confirmButtonText: 'Cerrar'
                });
                
            } catch (error) {
                console.error('Error cargando transferencias:', error);
                Swal.fire('Error', 'No se pudo cargar el historial', 'error');
            }
        };
        
        // ========== CARGAR SALDO ACTUAL ==========
        async function cargarSaldoActual() {
            const usuario = auth.getUsuario();
            if (!usuario) return 0;
            
            try {
                const { data, error } = await supabase
                    .from('saldo_usuarios')
                    .select('saldo_actual')
                    .eq('user_id', usuario.id)
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error;
                return data?.saldo_actual || 0;
            } catch (error) {
                console.error('Error cargando saldo:', error);
                return 0;
            }
        }
        
        // ========== CARGAR DATOS DEL USUARIO ==========
        async function cargarDatos() {
            document.getElementById('loadingContainer').style.display = 'block'
            document.getElementById('accountContent').style.display = 'none'
            
            const usuario = auth.getUsuario()
            pedidos = await auth.obtenerPedidos()
            direcciones = await auth.obtenerDirecciones()
            
            await renderizarCuenta(usuario)
            
            document.getElementById('loadingContainer').style.display = 'none'
            document.getElementById('accountContent').style.display = 'block'
        }
        
        // ========== RENDERIZAR CUENTA ==========
        async function renderizarCuenta(usuario) {
            const container = document.getElementById('accountContent')
            const saldo = await cargarSaldoActual()
            
            container.innerHTML = `
                <div class="account-header">
                    <div class="account-title">
                        <i class="fa fa-user-circle"></i>
                        <h1>Mi cuenta</h1>
                    </div>
                    <button class="btn btn-secondary" onclick="window.cerrarSesion()">
                        <i class="fa fa-sign-out"></i> Cerrar sesi√≥n
                    </button>
                </div>
                
                <!-- ACCIONES R√ÅPIDAS (NUEVO) -->
                <div class="quick-actions">
                    <a href="/transferir.html" class="quick-action-card">
                        <div class="quick-action-icon transfer">
                            <i class="fa fa-exchange"></i>
                        </div>
                        <div class="quick-action-content">
                            <h3>Transferir saldo</h3>
                            <p>Env√≠a dinero a otros usuarios</p>
                        </div>
                    </a>
                    
                    <a href="/recibir.html" class="quick-action-card">
                        <div class="quick-action-icon receive">
                            <i class="fa fa-qrcode"></i>
                        </div>
                        <div class="quick-action-content">
                            <h3>Recibir dinero</h3>
                            <p>Genera un c√≥digo QR para recibir pagos</p>
                        </div>
                    </a>
                    
                    <a href="/pagar-qr.html" class="quick-action-card">
                        <div class="quick-action-icon pay">
                            <i class="fa fa-camera"></i>
                        </div>
                        <div class="quick-action-content">
                            <h3>Pagar con QR</h3>
                            <p>Escanea y paga al instante</p>
                        </div>
                    </a>
                </div>
                
                <!-- TARJETA DE SALDO -->
                <div class="balance-card">
                    <div class="balance-icon">
                        <i class="fa fa-credit-card"></i>
                    </div>
                    <div class="balance-info">
                        <h3>Tu saldo CUBAZON</h3>
                        <div class="balance-amount">
                            $${saldo.toFixed(2)} <small>CUP</small>
                        </div>
                    </div>
                    <div class="balance-actions">
                        <a href="#" class="btn-balance" onclick="window.recargarSaldo()">
                            <i class="fa fa-plus-circle"></i> Recargar
                        </a>
                        <a href="#" class="btn-balance" onclick="window.historialSaldo()">
                            <i class="fa fa-history"></i> Historial
                        </a>
                        <a href="#" class="btn-balance" onclick="window.historialTransferencias()">
                            <i class="fa fa-exchange"></i> Transferencias
                        </a>
                    </div>
                </div>
                
                <div class="account-grid">
                    <!-- SIDEBAR -->
                    <div class="account-sidebar">
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fa fa-user"></i>
                            </div>
                            <div class="user-name">${usuario.nombre_completo || usuario.email?.split('@')[0] || 'Usuario'}</div>
                            <div class="user-email">${usuario.email}</div>
                        </div>
                        
                        <ul class="account-menu">
                            <li>
                                <a href="#" class="active" data-seccion="perfil">
                                    <i class="fa fa-user"></i> Mi perfil
                                </a>
                            </li>
                            <li>
                                <a href="#" data-seccion="pedidos">
                                    <i class="fa fa-shopping-bag"></i> Mis pedidos
                                    ${pedidos.length > 0 ? `<span style="margin-left: auto; background: #f08804; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${pedidos.length}</span>` : ''}
                                </a>
                            </li>
                            <li>
                                <a href="#" data-seccion="direcciones">
                                    <i class="fa fa-map-marker"></i> Mis direcciones
                                    ${direcciones.length > 0 ? `<span style="margin-left: auto; background: #6c757d; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${direcciones.length}</span>` : ''}
                                </a>
                            </li>
                            <li>
                                <a href="#" data-seccion="seguridad">
                                    <i class="fa fa-lock"></i> Seguridad
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- CONTENIDO -->
                    <div class="account-content" id="accountContentArea">
                        ${renderizarPerfil(usuario)}
                    </div>
                </div>
            `
            
            document.querySelectorAll('.account-menu a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault()
                    document.querySelectorAll('.account-menu a').forEach(l => l.classList.remove('active'))
                    this.classList.add('active')
                    
                    const seccion = this.dataset.seccion
                    seccionActual = seccion
                    
                    const contentArea = document.getElementById('accountContentArea')
                    
                    switch(seccion) {
                        case 'perfil':
                            contentArea.innerHTML = renderizarPerfil(usuario)
                            break
                        case 'pedidos':
                            contentArea.innerHTML = renderizarPedidos()
                            break
                        case 'direcciones':
                            contentArea.innerHTML = renderizarDirecciones()
                            break
                        case 'seguridad':
                            contentArea.innerHTML = renderizarSeguridad()
                            break
                    }
                })
            })
        }
        
        // ========== RENDERIZAR PERFIL ==========
        function renderizarPerfil(usuario) {
            return `
                <div class="section-title">
                    <span><i class="fa fa-user"></i> Mi perfil</span>
                    <button class="btn btn-secondary" onclick="window.editarPerfil()">
                        <i class="fa fa-edit"></i> Editar
                    </button>
                </div>
                
                <div class="profile-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre completo</label>
                            <input type="text" class="form-control" value="${usuario.nombre_completo || ''}" readonly disabled>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" value="${usuario.email}" readonly disabled>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="tel" class="form-control" value="${usuario.telefono || ''}" readonly disabled>
                        </div>
                        <div class="form-group">
                            <label>Carnet/Pasaporte</label>
                            <input type="text" class="form-control" value="${usuario.carnet || ''}" readonly disabled>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <input type="text" class="form-control" value="${usuario.direccion || ''}" readonly disabled>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Localidad</label>
                            <input type="text" class="form-control" value="${usuario.localidad || ''}" readonly disabled>
                        </div>
                        <div class="form-group">
                            <label>Referencia</label>
                            <input type="text" class="form-control" value="${usuario.referencia || ''}" readonly disabled>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                        <small style="color: #6c757d;">
                            <i class="fa fa-info-circle"></i> 
                            Miembro desde ${new Date(usuario.created_at).toLocaleDateString('es-ES', { year: 'numeric', month: 'long' })}
                        </small>
                    </div>
                </div>
            `
        }
        
        // ========== RENDERIZAR PEDIDOS MEJORADO ==========
        function renderizarPedidos() {
            if (pedidos.length === 0) {
                return `
                    <div class="section-title">
                        <span><i class="fa fa-shopping-bag"></i> Mis pedidos</span>
                    </div>
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fa fa-truck" style="font-size: 64px; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="margin-bottom: 15px;">No tienes pedidos a√∫n</h3>
                        <p style="color: #6c757d; margin-bottom: 30px;">Explora nuestra tienda y encuentra lo que buscas</p>
                        <a href="/" class="btn btn-primary" style="display: inline-block; padding: 12px 30px; text-decoration: none;">
                            <i class="fa fa-arrow-left"></i> Ir a comprar
                        </a>
                    </div>
                `
            }
            
            let html = `
                <div class="section-title">
                    <span><i class="fa fa-shopping-bag"></i> Mis pedidos</span>
                    <span style="font-size: 14px; font-weight: normal; color: #6c757d;">${pedidos.length} pedidos</span>
                </div>
                <div class="orders-list">
            `
            
            pedidos.forEach(p => {
                const fecha = new Date(p.created_at).toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })
                
                let statusClass = ''
                let statusText = ''
                switch(p.estado) {
                    case 'pendiente': 
                        statusClass = 'status-pendiente'
                        statusText = '‚è≥ Pendiente'
                        break
                    case 'enviado': 
                        statusClass = 'status-enviado'
                        statusText = 'üì¶ Enviado'
                        break
                    case 'entregado': 
                        statusClass = 'status-entregado'
                        statusText = '‚úÖ Entregado'
                        break
                    case 'cancelado': 
                        statusClass = 'status-cancelado'
                        statusText = '‚ùå Cancelado'
                        break
                    default: 
                        statusClass = 'status-pendiente'
                        statusText = '‚è≥ Pendiente'
                }
                
                const progreso = p.estado === 'pendiente' ? 25 : 
                                 p.estado === 'enviado' ? 75 : 
                                 p.estado === 'entregado' ? 100 : 0
                
                html += `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <span class="order-id">#${p.id.slice(0, 8)}</span>
                                <span class="order-date">${fecha}</span>
                            </div>
                            <span class="order-status ${statusClass}">${statusText}</span>
                        </div>
                        
                        <!-- BARRA DE PROGRESO -->
                        <div class="order-progress">
                            <div class="progress-steps">
                                <div class="progress-bar-bg">
                                    <div class="progress-bar-fill" style="width: ${progreso}%;"></div>
                                </div>
                                <div class="progress-step">
                                    <div class="step-icon ${progreso >= 25 ? 'completed' : ''}">
                                        <i class="fa fa-shopping-cart"></i>
                                    </div>
                                    <span class="step-label ${progreso >= 25 ? 'completed' : ''}">Pedido</span>
                                </div>
                                <div class="progress-step">
                                    <div class="step-icon ${progreso >= 50 ? 'completed' : progreso >= 25 ? 'active' : ''}">
                                        <i class="fa fa-check-circle"></i>
                                    </div>
                                    <span class="step-label ${progreso >= 50 ? 'completed' : progreso >= 25 ? 'active' : ''}">Pagado</span>
                                </div>
                                <div class="progress-step">
                                    <div class="step-icon ${progreso >= 75 ? 'completed' : progreso >= 50 ? 'active' : ''}">
                                        <i class="fa fa-truck"></i>
                                    </div>
                                    <span class="step-label ${progreso >= 75 ? 'completed' : progreso >= 50 ? 'active' : ''}">Enviado</span>
                                </div>
                                <div class="progress-step">
                                    <div class="step-icon ${progreso >= 100 ? 'completed' : progreso >= 75 ? 'active' : ''}">
                                        <i class="fa fa-home"></i>
                                    </div>
                                    <span class="step-label ${progreso >= 100 ? 'completed' : progreso >= 75 ? 'active' : ''}">Entregado</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- VISTA PREVIA DE PRODUCTOS -->
                        <div class="order-products" style="max-height: 200px; overflow-y: auto;">
                            ${p.items.slice(0, 2).map(item => `
                                <div class="order-product-item">
                                    <img src="${item.imagen_url || '/assets/images/no-image.jpg'}" class="order-product-image" onerror="this.src='/assets/images/no-image.jpg'">
                                    <div class="order-product-details">
                                        <div class="order-product-name">${item.nombre}</div>
                                        <div class="order-product-price">$${item.precio.toFixed(2)} CUP</div>
                                        <div class="order-product-specs">Cantidad: ${item.cantidad}</div>
                                    </div>
                                    <div class="order-product-subtotal">
                                        $${(item.precio * item.cantidad).toFixed(2)}
                                    </div>
                                </div>
                            `).join('')}
                            ${p.items.length > 2 ? `
                                <div style="text-align: center; padding: 10px; color: #007185;">
                                    Y ${p.items.length - 2} producto(s) m√°s...
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- RESUMEN R√ÅPIDO -->
                        <div class="order-summary" style="margin-top: 15px; padding: 15px;">
                            <div class="summary-row">
                                <span class="summary-label">Subtotal:</span>
                                <span class="summary-value">$${p.subtotal.toFixed(2)}</span>
                            </div>
                            <div class="summary-row">
                                <span class="summary-label">Env√≠o:</span>
                                <span class="summary-value">$${p.envio.toFixed(2)}</span>
                            </div>
                            ${p.descuento > 0 ? `
                                <div class="summary-row">
                                    <span class="summary-label">Descuento:</span>
                                    <span class="summary-value discount">-$${p.descuento.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="summary-row total">
                                <span class="summary-label">Total:</span>
                                <span class="summary-value">$${p.total.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-primary" style="flex: 1;" onclick="window.verDetallePedido('${p.id}')">
                                <i class="fa fa-eye"></i> Ver detalles
                            </button>
                            <button class="btn btn-secondary" style="flex: 1;" onclick="window.comprarDeNuevo('${p.id}')">
                                <i class="fa fa-repeat"></i> Comprar de nuevo
                            </button>
                        </div>
                    </div>
                `
            })
            
            html += `</div>`
            return html
        }
        
        // ========== VER DETALLE DE PEDIDO (MODAL) ==========
        window.verDetallePedido = async function(id) {
            const pedido = pedidos.find(p => p.id === id)
            if (!pedido) return
            
            const fecha = new Date(pedido.created_at).toLocaleString('es-ES')
            
            let statusClass = ''
            let statusText = ''
            switch(pedido.estado) {
                case 'pendiente': 
                    statusClass = 'status-pendiente'
                    statusText = '‚è≥ Pendiente'
                    break
                case 'enviado': 
                    statusClass = 'status-enviado'
                    statusText = 'üì¶ Enviado'
                    break
                case 'entregado': 
                    statusClass = 'status-entregado'
                    statusText = '‚úÖ Entregado'
                    break
                case 'cancelado': 
                    statusClass = 'status-cancelado'
                    statusText = '‚ùå Cancelado'
                    break
                default: 
                    statusClass = 'status-pendiente'
                    statusText = '‚è≥ Pendiente'
            }
            
            let productosHtml = ''
            pedido.items.forEach(item => {
                const specs = item.descripcion ? item.descripcion.split('\n').filter(l => l.includes(':')) : []
                
                productosHtml += `
                    <div class="order-product-item">
                        <img src="${item.imagen_url || '/assets/images/no-image.jpg'}" class="order-product-image" onerror="this.src='/assets/images/no-image.jpg'">
                        <div class="order-product-details">
                            <div class="order-product-name">${item.nombre}</div>
                            <div class="order-product-price">$${item.precio.toFixed(2)} CUP c/u</div>
                            <div class="order-product-specs">
                                Cantidad: ${item.cantidad}<br>
                                ${specs.length > 0 ? specs[0] : ''}
                                ${item.opciones?.talla ? `<br>Talla: ${item.opciones.talla}` : ''}
                            </div>
                        </div>
                        <div class="order-product-subtotal">
                            $${(item.precio * item.cantidad).toFixed(2)}
                        </div>
                    </div>
                `
            })
            
            document.getElementById('orderModalBody').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <span class="order-id">Pedido #${pedido.id.slice(0, 8)}</span>
                    <span class="order-status ${statusClass}" style="margin-left: 15px;">${statusText}</span>
                    <p style="margin-top: 10px; color: #6c757d;">${fecha}</p>
                </div>
                
                <h3 style="margin: 20px 0 15px;"><i class="fa fa-shopping-cart"></i> Productos</h3>
                <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                    ${productosHtml}
                </div>
                
                <h3 style="margin: 25px 0 15px;"><i class="fa fa-credit-card"></i> Resumen de pago</h3>
                <div class="order-summary" style="margin-top: 0;">
                    <div class="summary-row">
                        <span class="summary-label">Subtotal:</span>
                        <span class="summary-value">$${pedido.subtotal.toFixed(2)}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Env√≠o:</span>
                        <span class="summary-value">$${pedido.envio.toFixed(2)}</span>
                    </div>
                    ${pedido.descuento > 0 ? `
                        <div class="summary-row">
                            <span class="summary-label">Descuento:</span>
                            <span class="summary-value discount">-$${pedido.descuento.toFixed(2)}</span>
                        </div>
                    ` : ''}
                    <div class="summary-row total">
                        <span class="summary-label">Total:</span>
                        <span class="summary-value">$${pedido.total.toFixed(2)}</span>
                    </div>
                </div>
                
                <h3 style="margin: 25px 0 15px;"><i class="fa fa-map-marker"></i> Direcci√≥n de env√≠o</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <p><strong>${pedido.cliente.nombre}</strong></p>
                    <p>${pedido.cliente.direccion}</p>
                    <p>${pedido.cliente.localidad} ${pedido.cliente.referencia ? `(${pedido.cliente.referencia})` : ''}</p>
                    <p>Tel: ${pedido.cliente.telefono}</p>
                </div>
            `
            
            document.getElementById('orderModal').style.display = 'flex'
        }
        
        window.cerrarModal = function() {
            document.getElementById('orderModal').style.display = 'none'
        }
        
        // ========== RENDERIZAR DIRECCIONES ==========
        function renderizarDirecciones() {
            let html = `
                <div class="section-title">
                    <span><i class="fa fa-map-marker"></i> Mis direcciones</span>
                    <button class="btn btn-primary" onclick="window.agregarDireccion()">
                        <i class="fa fa-plus"></i> Nueva direcci√≥n
                    </button>
                </div>
            `
            
            if (direcciones.length === 0) {
                html += `
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fa fa-map-marker" style="font-size: 64px; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="margin-bottom: 15px;">No tienes direcciones guardadas</h3>
                        <p style="color: #6c757d; margin-bottom: 30px;">Agrega tu primera direcci√≥n para agilizar tus compras</p>
                        <button class="btn btn-primary" onclick="window.agregarDireccion()">
                            <i class="fa fa-plus"></i> Agregar direcci√≥n
                        </button>
                    </div>
                `
            } else {
                html += `<div style="display: grid; gap: 20px;">`
                
                direcciones.forEach(d => {
                    html += `
                        <div class="address-card">
                            ${d.es_principal ? '<span class="address-badge">Principal</span>' : ''}
                            <div class="address-name">${d.nombre}</div>
                            <div class="address-details">
                                ${d.direccion}<br>
                                ${d.localidad}${d.referencia ? ` - ${d.referencia}` : ''}<br>
                                Tel: ${d.telefono}
                            </div>
                            <div class="address-actions">
                                <button class="btn btn-secondary" onclick="window.editarDireccion(${d.id})">
                                    <i class="fa fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-secondary" onclick="window.eliminarDireccion(${d.id})">
                                    <i class="fa fa-trash"></i> Eliminar
                                </button>
                                ${!d.es_principal ? `
                                    <button class="btn btn-secondary" onclick="window.hacerPrincipal(${d.id})">
                                        <i class="fa fa-check-circle"></i> Hacer principal
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `
                })
                
                html += `</div>`
            }
            
            return html
        }
        
        // ========== RENDERIZAR SEGURIDAD ==========
        function renderizarSeguridad() {
            return `
                <div class="section-title">
                    <span><i class="fa fa-lock"></i> Seguridad</span>
                </div>
                
                <div style="max-width: 500px;">
                    <h3 style="font-size: 18px; margin-bottom: 20px;">Cambiar contrase√±a</h3>
                    
                    <div class="form-group">
                        <label>Contrase√±a actual</label>
                        <input type="password" id="currentPassword" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    
                    <div class="form-group">
                        <label>Nueva contrase√±a</label>
                        <input type="password" id="newPassword" class="form-control" placeholder="M√≠nimo 8 caracteres">
                    </div>
                    
                    <div class="form-group">
                        <label>Confirmar nueva contrase√±a</label>
                        <input type="password" id="confirmNewPassword" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    
                    <button class="btn btn-primary" onclick="window.cambiarPassword()">
                        <i class="fa fa-save"></i> Actualizar contrase√±a
                    </button>
                    
                    <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid #eee;">
                        <h3 style="font-size: 18px; margin-bottom: 15px; color: #dc3545;">Zona peligrosa</h3>
                        <button class="btn btn-danger" onclick="window.eliminarCuenta()">
                            <i class="fa fa-trash"></i> Eliminar mi cuenta
                        </button>
                        <p style="color: #6c757d; font-size: 13px; margin-top: 10px;">
                            Esta acci√≥n eliminar√° permanentemente tu cuenta y todos tus datos.
                        </p>
                    </div>
                </div>
            `
        }
        
        // ========== FUNCIONES GLOBALES ==========
        window.cerrarSesion = async function() {
            const result = await Swal.fire({
                title: '¬øCerrar sesi√≥n?',
                text: '¬øEst√°s seguro que deseas cerrar tu sesi√≥n?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, cerrar sesi√≥n',
                cancelButtonText: 'Cancelar'
            })
            
            if (result.isConfirmed) {
                await auth.cerrarSesion()
                window.location.href = '/'
            }
        }
        
        window.editarPerfil = async function() {
            const usuario = auth.getUsuario()
            
            const { value: formValues } = await Swal.fire({
                title: 'Editar perfil',
                html: `
                    <input type="text" id="nombre" class="swal2-input" placeholder="Nombre completo" value="${usuario.nombre_completo || ''}">
                    <input type="tel" id="telefono" class="swal2-input" placeholder="Tel√©fono" value="${usuario.telefono || ''}">
                    <input type="text" id="direccion" class="swal2-input" placeholder="Direcci√≥n" value="${usuario.direccion || ''}">
                    <input type="text" id="localidad" class="swal2-input" placeholder="Localidad" value="${usuario.localidad || ''}">
                    <input type="text" id="referencia" class="swal2-input" placeholder="Referencia" value="${usuario.referencia || ''}">
                    <input type="text" id="carnet" class="swal2-input" placeholder="Carnet/Pasaporte" value="${usuario.carnet || ''}">
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    return {
                        nombre_completo: document.getElementById('nombre').value,
                        telefono: document.getElementById('telefono').value,
                        direccion: document.getElementById('direccion').value,
                        localidad: document.getElementById('localidad').value,
                        referencia: document.getElementById('referencia').value,
                        carnet: document.getElementById('carnet').value
                    }
                }
            })
            
            if (formValues) {
                const resultado = await auth.actualizarPerfil(formValues)
                
                if (resultado.success) {
                    Swal.fire('¬°Actualizado!', 'Tu perfil ha sido actualizado', 'success')
                    cargarDatos()
                } else {
                    Swal.fire('Error', resultado.error, 'error')
                }
            }
        }
        
        window.agregarDireccion = async function() {
            const { value: formValues } = await Swal.fire({
                title: 'Nueva direcci√≥n',
                html: `
                    <input type="text" id="nombre" class="swal2-input" placeholder="Nombre de la direcci√≥n (Ej: Casa, Trabajo)" required>
                    <input type="text" id="direccion" class="swal2-input" placeholder="Direcci√≥n completa" required>
                    <input type="text" id="localidad" class="swal2-input" placeholder="Localidad/Barrio" required>
                    <input type="text" id="referencia" class="swal2-input" placeholder="Referencia">
                    <input type="tel" id="telefono" class="swal2-input" placeholder="Tel√©fono" required>
                    <label style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                        <input type="checkbox" id="esPrincipal"> 
                        <span>Establecer como direcci√≥n principal</span>
                    </label>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const nombre = document.getElementById('nombre').value;
                    const direc = document.getElementById('direccion').value;
                    const localidad = document.getElementById('localidad').value;
                    const referencia = document.getElementById('referencia').value;
                    const telefono = document.getElementById('telefono').value;
                    const esPrincipal = document.getElementById('esPrincipal').checked;
                    
                    if (!nombre || !direc || !localidad || !telefono) {
                        Swal.showValidationMessage('Todos los campos obligatorios deben estar llenos');
                        return false;
                    }
                    
                    return { 
                        nombre, 
                        direccion: direc, 
                        localidad, 
                        referencia, 
                        telefono, 
                        es_principal: esPrincipal 
                    };
                }
            });
            
            if (formValues) {
                try {
                    if (formValues.es_principal) {
                        await supabase
                            .from('direcciones')
                            .update({ es_principal: false })
                            .eq('usuario_id', auth.getUsuario().id);
                    }
                    
                    const { error } = await supabase
                        .from('direcciones')
                        .insert([{
                            usuario_id: auth.getUsuario().id,
                            ...formValues
                        }]);
                    
                    if (error) throw error;
                    
                    Swal.fire('¬°Agregada!', 'Direcci√≥n guardada correctamente', 'success');
                    direcciones = await auth.obtenerDirecciones();
                    renderizarCuenta(auth.getUsuario());
                    
                } catch (error) {
                    console.error('Error al agregar direcci√≥n:', error);
                    Swal.fire('Error', 'No se pudo guardar la direcci√≥n', 'error');
                }
            }
        };
        
        window.editarDireccion = async function(id) {
            const direccion = direcciones.find(d => d.id === id);
            if (!direccion) {
                Swal.fire('Error', 'Direcci√≥n no encontrada', 'error');
                return;
            }
            
            const { value: formValues } = await Swal.fire({
                title: 'Editar direcci√≥n',
                html: `
                    <input type="text" id="nombre" class="swal2-input" placeholder="Nombre de la direcci√≥n" value="${direccion.nombre || ''}" required>
                    <input type="text" id="direccion" class="swal2-input" placeholder="Direcci√≥n completa" value="${direccion.direccion || ''}" required>
                    <input type="text" id="localidad" class="swal2-input" placeholder="Localidad/Barrio" value="${direccion.localidad || ''}" required>
                    <input type="text" id="referencia" class="swal2-input" placeholder="Referencia" value="${direccion.referencia || ''}">
                    <input type="tel" id="telefono" class="swal2-input" placeholder="Tel√©fono" value="${direccion.telefono || ''}" required>
                    <label style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                        <input type="checkbox" id="esPrincipal" ${direccion.es_principal ? 'checked' : ''}> 
                        <span>Establecer como direcci√≥n principal</span>
                    </label>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const nombre = document.getElementById('nombre').value;
                    const direc = document.getElementById('direccion').value;
                    const localidad = document.getElementById('localidad').value;
                    const referencia = document.getElementById('referencia').value;
                    const telefono = document.getElementById('telefono').value;
                    const esPrincipal = document.getElementById('esPrincipal').checked;
                    
                    if (!nombre || !direc || !localidad || !telefono) {
                        Swal.showValidationMessage('Todos los campos obligatorios deben estar llenos');
                        return false;
                    }
                    
                    return { nombre, direccion: direc, localidad, referencia, telefono, es_principal: esPrincipal };
                }
            });
            
            if (formValues) {
                try {
                    if (formValues.es_principal) {
                        await supabase
                            .from('direcciones')
                            .update({ es_principal: false })
                            .eq('usuario_id', auth.getUsuario().id)
                            .neq('id', id);
                    }
                    
                    const { error } = await supabase
                        .from('direcciones')
                        .update({
                            nombre: formValues.nombre,
                            direccion: formValues.direccion,
                            localidad: formValues.localidad,
                            referencia: formValues.referencia,
                            telefono: formValues.telefono,
                            es_principal: formValues.es_principal,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    Swal.fire('¬°Actualizada!', 'Direcci√≥n actualizada correctamente', 'success');
                    direcciones = await auth.obtenerDirecciones();
                    renderizarCuenta(auth.getUsuario());
                    
                } catch (error) {
                    console.error('Error al editar direcci√≥n:', error);
                    Swal.fire('Error', 'No se pudo actualizar la direcci√≥n', 'error');
                }
            }
        };
        
        window.hacerPrincipal = async function(id) {
            const result = await Swal.fire({
                title: '¬øEstablecer como principal?',
                text: 'Esta direcci√≥n ser√° la predeterminada para tus compras',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, hacer principal',
                cancelButtonText: 'Cancelar'
            });
            
            if (result.isConfirmed) {
                try {
                    await supabase
                        .from('direcciones')
                        .update({ es_principal: false })
                        .eq('usuario_id', auth.getUsuario().id);
                    
                    const { error } = await supabase
                        .from('direcciones')
                        .update({ es_principal: true })
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    Swal.fire({
                        icon: 'success',
                        title: '¬°Actualizado!',
                        text: 'Direcci√≥n principal actualizada',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    direcciones = await auth.obtenerDirecciones();
                    renderizarCuenta(auth.getUsuario());
                    
                } catch (error) {
                    console.error('Error al hacer principal:', error);
                    Swal.fire('Error', 'No se pudo actualizar la direcci√≥n principal', 'error');
                }
            }
        };
        
        window.eliminarCuenta = async function() {
            const result = await Swal.fire({
                title: '¬øEliminar tu cuenta?',
                text: 'Esta acci√≥n eliminar√° permanentemente tu cuenta, direcciones, pedidos y saldo. No se puede deshacer.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: 'S√≠, eliminar mi cuenta',
                cancelButtonText: 'Cancelar',
                input: 'password',
                inputLabel: 'Confirma tu contrase√±a',
                inputPlaceholder: 'Escribe tu contrase√±a',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Debes escribir tu contrase√±a';
                    }
                }
            });
            
            if (result.isConfirmed) {
                try {
                    const password = result.value;
                    const usuario = auth.getUsuario();
                    
                    const { error: signInError } = await supabase.auth.signInWithPassword({
                        email: usuario.email,
                        password: password
                    });
                    
                    if (signInError) {
                        throw new Error('Contrase√±a incorrecta');
                    }
                    
                    await supabase
                        .from('direcciones')
                        .delete()
                        .eq('usuario_id', usuario.id);
                    
                    await supabase
                        .from('historial_saldo')
                        .delete()
                        .eq('user_id', usuario.id);
                    
                    await supabase
                        .from('saldo_usuarios')
                        .delete()
                        .eq('user_id', usuario.id);
                    
                    await supabase
                        .from('solicitudes_recarga')
                        .delete()
                        .eq('user_id', usuario.id);
                    
                    await supabase
                        .from('perfiles')
                        .delete()
                        .eq('id', usuario.id);
                    
                    const { error: deleteError } = await supabase.auth.admin.deleteUser(usuario.id);
                    
                    if (deleteError) {
                        await auth.cerrarSesion();
                    } else {
                        await auth.cerrarSesion();
                    }
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Cuenta eliminada',
                        text: 'Lamentamos verte ir. ¬°Esperamos verte de nuevo!',
                        confirmButtonText: 'Ir al inicio'
                    }).then(() => {
                        window.location.href = '/';
                    });
                    
                } catch (error) {
                    console.error('Error al eliminar cuenta:', error);
                    Swal.fire('Error', error.message || 'No se pudo eliminar la cuenta', 'error');
                }
            }
        };
        
        window.eliminarDireccion = async function(id) {
            const result = await Swal.fire({
                title: '¬øEliminar direcci√≥n?',
                text: 'Esta acci√≥n no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            })
            
            if (result.isConfirmed) {
                const resultado = await auth.eliminarDireccion(id)
                
                if (resultado.success) {
                    Swal.fire('¬°Eliminada!', 'Direcci√≥n eliminada correctamente', 'success')
                    direcciones = await auth.obtenerDirecciones()
                    renderizarCuenta(auth.getUsuario())
                } else {
                    Swal.fire('Error', resultado.error, 'error')
                }
            }
        }
        
        window.cambiarPassword = async function() {
            const current = document.getElementById('currentPassword')?.value
            const newPass = document.getElementById('newPassword')?.value
            const confirmPass = document.getElementById('confirmNewPassword')?.value
            
            if (!current || !newPass || !confirmPass) {
                Swal.fire('Error', 'Completa todos los campos', 'error')
                return
            }
            
            if (newPass !== confirmPass) {
                Swal.fire('Error', 'Las contrase√±as no coinciden', 'error')
                return
            }
            
            if (newPass.length < 8) {
                Swal.fire('Error', 'La contrase√±a debe tener al menos 8 caracteres', 'error')
                return
            }
            
            const resultado = await auth.cambiarPassword(current, newPass)
            
            if (resultado.success) {
                Swal.fire('¬°Actualizada!', 'Tu contrase√±a ha sido cambiada', 'success')
                document.getElementById('currentPassword').value = ''
                document.getElementById('newPassword').value = ''
                document.getElementById('confirmNewPassword').value = ''
            } else {
                Swal.fire('Error', resultado.error, 'error')
            }
        }
        
        window.comprarDeNuevo = async function(id) {
            const pedido = pedidos.find(p => p.id === id)
            if (!pedido) return
            
            for (const item of pedido.items) {
                await carrito.agregar(item.id, item.cantidad, item.opciones || {})
            }
            
            Swal.fire({
                icon: 'success',
                title: '¬°Productos agregados!',
                text: 'Los productos se han agregado a tu carrito',
                confirmButtonText: 'Ver carrito',
                showCancelButton: true,
                cancelButtonText: 'Seguir comprando'
            }).then(result => {
                if (result.isConfirmed) {
                    window.location.href = '/p/cart.html'
                }
            })
        }
        
        // ========== INICIALIZAR ==========
        cargarDatos()
        
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('orderModal')
            if (e.target === modal) {
                modal.style.display = 'none'
            }
        })
    </script>
</body>
</html>