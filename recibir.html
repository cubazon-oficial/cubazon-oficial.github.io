<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recibir dinero ¬∑ CUBAZON</title>
    
    <!-- Mismos estilos -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #f0f2f5;
            color: #0f1111;
            line-height: 1.5;
        }
        
        /* Header id√©ntico */
        #header-wrap {
            background: #131921;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-header { padding: 10px 20px; }
        .container.row {
            max-width: 1500px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-logo img { height: 50px; width: auto; }
        .header-right { display: flex; align-items: center; gap: 25px; }
        .right-menu ul {
            display: flex;
            gap: 20px;
            list-style: none;
            align-items: center;
        }
        .right-menu ul li a {
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .sora-cart { position: relative; }
        .sora-cart-details {
            display: flex;
            align-items: center;
            color: white;
            cursor: pointer;
        }
        .sora-cart-details:after {
            content: '\f290';
            font-family: 'FontAwesome';
            font-size: 24px;
            margin-left: 5px;
        }
        .simpleCart_quantity {
            background: #f08804;
            color: #0f1111;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 20px;
            margin-left: 5px;
        }
        .header-menu {
            background: #232f3e;
            padding: 0 20px;
        }
        #main-menu ul {
            display: flex;
            list-style: none;
            gap: 20px;
        }
        #main-menu ul li a {
            color: white;
            font-size: 14px;
            font-weight: 500;
            padding: 8px 0;
            display: block;
        }
        
        /* Contenedor principal */
        .recibir-container {
            max-width: 600px;
            margin: 50px auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .recibir-container.pagado {
            background: #f0fff0;
            box-shadow: 0 0 30px #28a745;
        }
        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #0f1111;
        }
        .subtitle {
            color: #6c757d;
            margin-bottom: 30px;
        }
        .saldo-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            transition: all 0.3s;
        }
        .saldo-card.pagado {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .saldo-card h3 {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .saldo-card .saldo-amount {
            font-size: 32px;
            font-weight: 700;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #0f1111;
        }
        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }
        .form-control:focus {
            border-color: #f08804;
            outline: none;
        }
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #ffd814;
            color: #0f1111;
        }
        .btn-primary:hover {
            background: #f7ca00;
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .qr-container {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            display: none;
        }
        .qr-container h3 {
            margin-bottom: 15px;
        }
        .qr-image {
            width: 250px;
            height: 250px;
            margin: 20px auto;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .qr-timer {
            font-size: 18px;
            font-weight: 600;
            color: #dc3545;
            margin: 10px 0;
        }
        .qr-descripcion {
            color: #6c757d;
            margin: 10px 0;
        }
        .estado-pago {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
            display: none;
        }
        .estado-pago.pendiente {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .estado-pago.pagado {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Footer */
        #footer-wrapper {
            background: #232f3e;
            color: white;
            padding: 50px 20px;
            margin-top: 50px;
        }
        .footer-widgets-wrap {
            max-width: 1500px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 40px;
        }
        #sub-footer-wrapper {
            background: #131921;
            padding: 20px;
            text-align: center;
            color: #ddd;
        }
        
        @media (max-width: 768px) {
            .recibir-container {
                margin: 20px;
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <!-- Audio para notificaci√≥n -->
    <audio id="notificacionSound" preload="auto">
        <source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3" type="audio/mpeg">
    </audio>

    <!-- ===== HEADER ===== -->
    <div id="header-wrap">
        <div class="header-header">
            <div class="container row">
                <div class="header-logo">
                    <a href="/">
                        <img src="http://imgfz.com/i/oXOfVlT.png" alt="CUBAZON" style="height: 50px;">
                    </a>
                </div>
                <div class="header-right">
                    <div class="right-menu">
                        <ul>
                            <li><a href="/login.html" id="userMenuLink">
                                <i class="fa fa-sign-in"></i> 
                                <span id="userMenuText">Iniciar sesi√≥n</span>
                            </a></li>
                            <li><a href="/p/cart.html"><i class="fa fa-shopping-cart"></i> <span id="cart-counter" class="simpleCart_quantity">0</span></a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-menu">
            <div class="container row">
                <div id="main-menu">
                    <ul>
                        <li><a href="/">Inicio</a></li>
                        <li><a href="/mi-cuenta.html">Mi Cuenta</a></li>
                        <li><a href="/transferir.html">Transferir Saldo</a></li>
                        <li><a href="/recibir.html">Recibir Dinero</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== CONTENIDO PRINCIPAL ===== -->
    <div class="recibir-container" id="mainContainer">
        <h1>üì≤ Recibir dinero</h1>
        <p class="subtitle">Genera un c√≥digo QR para que te paguen al instante</p>
        
        <div id="loadingIndicator" style="text-align: center; padding: 20px; display: none;">
            <i class="fa fa-spinner fa-pulse fa-2x"></i>
            <p>Cargando...</p>
        </div>
        
        <div id="saldoCard" class="saldo-card">
            <h3>Tu saldo actual</h3>
            <div class="saldo-amount" id="saldoDisplay">$0.00</div>
        </div>
        
        <form id="recibirForm">
            <div class="form-group">
                <label>Monto a recibir <span style="font-weight: normal; color: #6c757d;">(opcional)</span></label>
                <input type="number" id="monto" class="form-control" min="1" step="0.01" placeholder="Deja vac√≠o para cualquier monto">
            </div>
            
            <div class="form-group">
                <label>Concepto <span style="font-weight: normal; color: #6c757d;">(opcional)</span></label>
                <input type="text" id="concepto" class="form-control" placeholder="Ej: Pago de producto">
            </div>
            
            <button type="submit" class="btn btn-primary" id="generarQRBtn">
                <i class="fa fa-qrcode"></i> Generar c√≥digo QR
            </button>
        </form>
        
        <div id="qrContainer" class="qr-container">
            <h3>üìå Escanea este c√≥digo para recibir el pago</h3>
            <img id="qrImage" class="qr-image" src="" alt="QR de pago">
            <div id="qrTimer" class="qr-timer"></div>
            <p id="qrDescripcion" class="qr-descripcion"></p>
            <div id="estadoPago" class="estado-pago pendiente">
                ‚è≥ Esperando pago...
            </div>
            <button class="btn btn-primary" id="generarOtroBtn" style="margin-top: 15px;">
                <i class="fa fa-refresh"></i> Generar otro QR
            </button>
        </div>
    </div>

    <!-- ===== FOOTER ===== -->
    <div id="footer-wrapper">
        <div class="footer-widgets-wrap">
            <div class="footer">
                <h3>CUBAZON</h3>
                <p>Tu tienda online de confianza en Sagua de T√°namo.</p>
            </div>
        </div>
    </div>
    <div id="sub-footer-wrapper">
        <p>@Copyright 2026 CUBAZON</p>
    </div>

    <script type="module">
        import { supabase } from '/js/supabase-client.js';
        import { auth } from '/js/auth.js';
        import { initCarrito } from '/js/cart.js';
        
        // Inicializar carrito
        const carrito = initCarrito();
        window.cart = carrito;
        carrito.cargarDeLocalStorage();
        carrito.actualizarInterfaz();
        
        // Elementos DOM
        const loadingIndicator = document.getElementById('loadingIndicator');
        const saldoCard = document.getElementById('saldoCard');
        const mainContainer = document.getElementById('mainContainer');
        const recibirForm = document.getElementById('recibirForm');
        const qrContainer = document.getElementById('qrContainer');
        const estadoPago = document.getElementById('estadoPago');
        const generarOtroBtn = document.getElementById('generarOtroBtn');
        const notificacionSound = document.getElementById('notificacionSound');
        let timerInterval;
        let pollingInterval = null;
        let peticionActiva = null;
        
        // ========== REPRODUCIR SONIDO ==========
        function reproducirSonido() {
            try {
                notificacionSound.play().catch(e => console.log('Error reproduciendo sonido:', e));
            } catch (e) {
                console.log('Error con audio:', e);
            }
        }
        
        // ========== MOSTRAR NOTIFICACI√ìN ==========
        function mostrarPagoRecibido(monto) {
            // Reproducir sonido
            reproducirSonido();
            
            // Actualizar UI
            estadoPago.className = 'estado-pago pagado';
            estadoPago.innerHTML = 'üéâ ¬°PAGO RECIBIDO! üéâ';
            saldoCard.classList.add('pagado');
            mainContainer.classList.add('pagado');
            
            // SweetAlert
            Swal.fire({
                icon: 'success',
                title: '¬°Pago recibido!',
                text: `Se acreditaron $${monto.toFixed(2)} CUP`,
                timer: 5000,
                showConfirmButton: true,
                confirmButtonText: 'Ver mi saldo'
            });
            
            // Vibraci√≥n si es m√≥vil
            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500]);
            }
            
            // Detener temporizador
            if (timerInterval) clearInterval(timerInterval);
        }
        
        // ========== ACTUALIZAR MEN√ö DE USUARIO ==========
        function actualizarMenuUsuario() {
            const userMenuLink = document.getElementById('userMenuLink');
            const userMenuText = document.getElementById('userMenuText');
            if (!userMenuLink || !userMenuText) return;
            
            if (auth.isAuthenticated()) {
                const usuario = auth.getUsuario();
                const nombre = usuario?.nombre_completo || usuario?.email?.split('@')[0] || 'Mi cuenta';
                userMenuText.textContent = nombre;
                userMenuLink.href = '/mi-cuenta.html';
                userMenuLink.innerHTML = `<i class="fa fa-user"></i> ${nombre}`;
            } else {
                userMenuText.textContent = 'Iniciar sesi√≥n';
                userMenuLink.href = '/login.html?redirect=/recibir.html';
                userMenuLink.innerHTML = '<i class="fa fa-sign-in"></i> Iniciar sesi√≥n';
            }
        }
        
        // ========== VERIFICAR AUTENTICACI√ìN ==========
        async function verificarAuth() {
            loadingIndicator.style.display = 'block';
            
            for (let i = 0; i < 20; i++) {
                if (auth.isAuthenticated()) {
                    console.log('‚úÖ Usuario autenticado');
                    loadingIndicator.style.display = 'none';
                    await cargarSaldo();
                    return;
                }
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            loadingIndicator.style.display = 'none';
            sessionStorage.setItem('redirect_after_login', '/recibir.html');
            window.location.href = '/login.html?redirect=/recibir.html';
        }
        
        // ========== CARGAR SALDO ==========
        async function cargarSaldo() {
            const usuario = auth.getUsuario();
            if (!usuario) return;
            
            const { data, error } = await supabase
                .from('saldo_usuarios')
                .select('saldo_actual')
                .eq('user_id', usuario.id)
                .single();
            
            if (error && error.code !== 'PGRST116') {
                console.error('Error cargando saldo:', error);
            }
            
            const saldo = data?.saldo_actual || 0;
            document.getElementById('saldoDisplay').textContent = `$${saldo.toFixed(2)}`;
        }
        
        // ========== GENERAR QR ==========
        async function generarQR(monto, concepto) {
            const usuario = auth.getUsuario();
            
            const codigo = 'REC-' + Math.random().toString(36).substr(2, 12).toUpperCase() + Date.now().toString(36);
            
            const { data, error } = await supabase
                .from('peticiones_pago')
                .insert({
                    codigo: codigo,
                    receptor_id: usuario.id,
                    monto: monto || null,
                    concepto: concepto || null,
                    expira: new Date(Date.now() + 5 * 60000).toISOString(),
                    estado: 'activa'
                })
                .select()
                .single();
            
            if (error) {
                console.error('Error guardando petici√≥n:', error);
                Swal.fire('Error', 'No se pudo generar el c√≥digo QR', 'error');
                return null;
            }
            
            return { codigo, id: data.id };
        }
        
        // ========== FUNCI√ìN AUXILIAR PARA PROCESAR PAGO ==========
        async function procesarPagoRecibido(peticionId, monto) {
            // Marcar petici√≥n como pagada
            await supabase
                .from('peticiones_pago')
                .update({ estado: 'pagada' })
                .eq('id', peticionId);
            
            // Actualizar UI
            mostrarPagoRecibido(monto);
            
            // Detener polling
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
        
        // ========== ESCUCHAR CAMBIOS EN EL SALDO (VERSI√ìN QUE MANEJA NULL) ==========
        function escucharSaldo(peticionId, montoEsperado) {
            const usuario = auth.getUsuario();
            if (!usuario) return;
            
            // Cancelar polling anterior si existe
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            // Obtener saldo inicial
            const saldoInicial = parseFloat(document.getElementById('saldoDisplay').textContent.replace('$', ''));
            
            console.log('üéß Iniciando polling cada 2 segundos...', { 
                saldoInicial, 
                montoEsperado: montoEsperado || 'CUALQUIER MONTO'
            });
            
            // Polling cada 2 segundos
            pollingInterval = setInterval(async () => {
                try {
                    // Consultar saldo actual
                    const { data, error } = await supabase
                        .from('saldo_usuarios')
                        .select('saldo_actual')
                        .eq('user_id', usuario.id)
                        .single();
                    
                    if (error) {
                        console.error('Error consultando saldo:', error);
                        return;
                    }
                    
                    const nuevoSaldo = data.saldo_actual;
                    const saldoActualDisplay = parseFloat(document.getElementById('saldoDisplay').textContent.replace('$', ''));
                    
                    // Si el saldo cambi√≥
                    if (Math.abs(nuevoSaldo - saldoActualDisplay) > 0.01) {
                        console.log('üí∞ Saldo detectado por polling:', nuevoSaldo);
                        document.getElementById('saldoDisplay').textContent = `$${nuevoSaldo.toFixed(2)}`;
                        
                        // Calcular aumento
                        const aumento = nuevoSaldo - saldoInicial;
                        
                        // CASO 1: Hay monto espec√≠fico
                        if (montoEsperado !== null && montoEsperado !== undefined) {
                            console.log('üìä Comparaci√≥n (monto espec√≠fico):', {
                                aumento: aumento.toFixed(2),
                                montoEsperado: montoEsperado.toFixed(2),
                                diferencia: (aumento - montoEsperado).toFixed(2)
                            });
                            
                            if (Math.abs(aumento - montoEsperado) < 0.02) {
                                console.log('‚úÖ ¬°PAGO RECIBIDO (monto exacto)!');
                                await procesarPagoRecibido(peticionId, montoEsperado);
                            }
                        } 
                        // CASO 2: QR libre (cualquier monto)
                        else {
                            console.log('üìä QR libre - aumento detectado:', aumento.toFixed(2));
                            
                            // Si aument√≥ el saldo, es un pago (cualquier monto)
                            if (aumento > 0.01) {
                                console.log('‚úÖ ¬°PAGO RECIBIDO (monto libre)!');
                                await procesarPagoRecibido(peticionId, aumento);
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error en polling:', e);
                }
            }, 2000); // Cada 2 segundos
        }
        
        // ========== MOSTRAR QR CON TEMPORIZADOR ==========
        function mostrarQR(codigo, monto, concepto, peticionId) {
            const urlPago = `${window.location.origin}/pagar-qr.html?c=${codigo}`;
            
            qrContainer.style.display = 'block';
            document.getElementById('qrImage').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(urlPago)}`;
            
            let descripcion = '';
            if (monto) {
                descripcion = `Recibir√°s: $${parseFloat(monto).toFixed(2)} CUP`;
            } else {
                descripcion = `Puedes recibir cualquier monto`;
            }
            if (concepto) descripcion += ` ¬∑ Concepto: ${concepto}`;
            document.getElementById('qrDescripcion').textContent = descripcion;
            
            // Reiniciar estado
            estadoPago.className = 'estado-pago pendiente';
            estadoPago.innerHTML = '‚è≥ Esperando pago...';
            estadoPago.style.display = 'block';
            saldoCard.classList.remove('pagado');
            mainContainer.classList.remove('pagado');
            
            // Iniciar escucha de saldo (POLLING)
            escucharSaldo(peticionId, monto ? parseFloat(monto) : null);
            
            // Temporizador de 5 minutos
            const expira = new Date(Date.now() + 5 * 60000);
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = expira - now;
                
                if (diff <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('qrTimer').textContent = '‚è∞ C√≥digo expirado';
                    document.getElementById('qrTimer').style.color = '#dc3545';
                    estadoPago.innerHTML = '‚ùå C√≥digo expirado';
                    
                    // Detener polling
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                    }
                    return;
                }
                
                const minutos = Math.floor(diff / 60000);
                const segundos = Math.floor((diff % 60000) / 1000);
                document.getElementById('qrTimer').textContent = `‚è≥ V√°lido por: ${minutos}:${segundos.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // ========== EVENTO DEL FORMULARIO ==========
        document.getElementById('recibirForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const monto = document.getElementById('monto').value;
            const concepto = document.getElementById('concepto').value;
            const btn = document.getElementById('generarQRBtn');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fa fa-spinner fa-pulse"></i> Generando...';
            
            try {
                const resultado = await generarQR(monto, concepto);
                if (resultado) {
                    mostrarQR(resultado.codigo, monto, concepto, resultado.id);
                }
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'Ocurri√≥ un error al generar el QR', 'error');
            }
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fa fa-qrcode"></i> Generar c√≥digo QR';
        });
        
        // ========== GENERAR OTRO QR ==========
        generarOtroBtn.addEventListener('click', () => {
            qrContainer.style.display = 'none';
            estadoPago.style.display = 'none';
            if (timerInterval) clearInterval(timerInterval);
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            document.getElementById('recibirForm').reset();
        });
        
        // ========== INICIALIZAR ==========
        actualizarMenuUsuario();
        auth.onCambio(actualizarMenuUsuario);
        verificarAuth();
    </script>
</body>
</html>
