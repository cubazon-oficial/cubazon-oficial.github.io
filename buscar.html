<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscar productos · CUBAZON</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- Owl Carousel -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">
    
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <!-- NOUI SLIDER PARA RANGOS DE PRECIO -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f0f2f5;
            color: #0f1111;
            line-height: 1.5;
        }

        a {
            text-decoration: none;
            color: #007185;
        }

        a:hover {
            color: #c7511f;
        }

        /* ===== HEADER ===== */
        #header-wrap {
            background: #131921;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-header {
            padding: 10px 20px;
        }

        .container.row {
            max-width: 1500px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-logo img {
            height: 50px;
            width: auto;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .top-bar-social ul {
            display: flex;
            gap: 15px;
        }

        .top-bar-social ul li a {
            color: white;
            font-size: 18px;
        }

        .right-menu ul {
            display: flex;
            gap: 20px;
        }

        .right-menu ul li a {
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sora-cart {
            position: relative;
        }

        .sora-cart-details {
            display: flex;
            align-items: center;
            color: white;
            cursor: pointer;
        }

        .sora-cart-details:after {
            content: '\f290';
            font-family: 'FontAwesome';
            font-size: 24px;
            margin-left: 5px;
        }

        .simpleCart_quantity {
            background: #f08804;
            color: #0f1111;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 20px;
            margin-left: 5px;
        }

        .sora-cart-description {
            position: absolute;
            right: 0;
            top: 40px;
            width: 350px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 20px;
            display: none;
            z-index: 1000;
        }

        .sora-cart:hover .sora-cart-description {
            display: block;
        }

        .header-menu {
            background: #232f3e;
            padding: 0 20px;
        }

        #main-menu ul {
            display: flex;
            list-style: none;
            gap: 20px;
        }

        #main-menu ul li a {
            color: white;
            font-size: 14px;
            font-weight: 500;
            padding: 8px 0;
            display: block;
        }

        /* ===== BREADCRUMB ===== */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #6c757d;
        }

        .breadcrumb a {
            color: #007185;
        }

        .breadcrumb i {
            font-size: 12px;
            color: #6c757d;
        }

        /* ===== BUSCADOR AVANZADO ===== */
        .search-container {
            max-width: 1500px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .search-header {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .search-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #0f1111;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-title i {
            color: #f08804;
        }

        .search-main {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: #f08804;
            outline: none;
            box-shadow: 0 0 0 3px rgba(240,136,4,0.1);
        }

        .search-button {
            padding: 15px 30px;
            background: #f08804;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .search-button:hover {
            background: #e07c00;
        }

        /* ===== FILTROS AVANZADOS ===== */
        .filters-grid {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 30px;
        }

        .filters-sidebar {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            height: fit-content;
        }

        .filters-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-group {
            margin-bottom: 25px;
        }

        .filter-group h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #0f1111;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .filter-option input[type="checkbox"],
        .filter-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .filter-option label {
            cursor: pointer;
            flex: 1;
            color: #0f1111;
        }

        .filter-count {
            color: #6c757d;
            font-size: 13px;
        }

        /* ===== SLIDER DE PRECIO ===== */
        .price-range {
            padding: 10px 0 20px;
        }

        #priceSlider {
            margin: 20px 0;
        }

        .price-inputs {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 15px;
        }

        .price-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* ===== CATEGORÍAS EN ÁRBOL ===== */
        .category-tree {
            list-style: none;
            margin-left: 15px;
        }

        .category-item {
            margin-bottom: 10px;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .category-children {
            margin-left: 25px;
            margin-top: 8px;
        }

        /* ===== TAGS Y ETIQUETAS ===== */
        .tags-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag-item {
            background: #e9ecef;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag-item:hover {
            background: #f08804;
            color: white;
        }

        .tag-item.active {
            background: #f08804;
            color: white;
        }

        /* ===== RESULTADOS DE BÚSQUEDA ===== */
        .results-header {
            background: white;
            border-radius: 8px;
            padding: 20px 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .results-stats {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .results-count {
            font-size: 16px;
            font-weight: 600;
        }

        .results-time {
            color: #6c757d;
            font-size: 14px;
        }

        .results-sort {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
            background: white;
            cursor: pointer;
        }

        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .filter-tag {
            background: #e9ecef;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-tag i {
            cursor: pointer;
            color: #6c757d;
        }

        .filter-tag i:hover {
            color: #dc3545;
        }

        .clear-filters {
            color: #007185;
            font-size: 13px;
            cursor: pointer;
            background: none;
            border: none;
        }

        /* ===== GRID DE PRODUCTOS ===== */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
        }

        .product-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            margin-bottom: 15px;
        }

        .product-title {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 8px;
            line-height: 1.4;
            height: 42px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .product-rating {
            color: #ffa41c;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .product-price {
            font-size: 20px;
            font-weight: 700;
            color: #b12704;
            margin: 10px 0;
        }

        .product-price small {
            font-size: 13px;
            font-weight: 400;
            color: #565959;
            margin-left: 5px;
        }

        .product-original-price {
            font-size: 13px;
            color: #6c757d;
            text-decoration: line-through;
            margin-left: 8px;
        }

        .product-discount {
            display: inline-block;
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .product-stock {
            font-size: 12px;
            margin-bottom: 15px;
        }

        .stock-available {
            color: #007600;
        }

        .stock-low {
            color: #856404;
        }

        .stock-out {
            color: #dc3545;
        }

        .btn-add-cart {
            background: #ffd814;
            border: none;
            border-radius: 20px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 600;
            color: #0f1111;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-add-cart:hover {
            background: #f7ca00;
        }

        .product-agotado {
            background: #dc3545;
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            margin-top: 10px;
        }

        /* ===== PAGINACIÓN ===== */
        .pagination {
            margin-top: 50px;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .pagination-item {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-item:hover {
            border-color: #f08804;
            background: #fff6e5;
        }

        .pagination-item.active {
            background: #f08804;
            color: white;
            border-color: #f08804;
        }

        .pagination-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ===== NO RESULTS ===== */
        .no-results {
            text-align: center;
            padding: 80px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .no-results i {
            font-size: 64px;
            color: #dee2e6;
            margin-bottom: 20px;
        }

        .no-results h2 {
            margin-bottom: 10px;
            color: #0f1111;
        }

        .no-results p {
            color: #6c757d;
            margin-bottom: 30px;
        }

        .no-results .btn {
            display: inline-block;
            padding: 12px 30px;
            background: #ffd814;
            border: none;
            border-radius: 20px;
            color: #0f1111;
            font-weight: 600;
            text-decoration: none;
        }

        /* ===== LOADING ===== */
        .loading-container {
            text-align: center;
            padding: 100px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .loading-container i {
            font-size: 64px;
            color: #009644;
            margin-bottom: 20px;
        }

        /* ===== FOOTER ===== */
        #footer-wrapper {
            background: #232f3e;
            color: white;
            padding: 50px 20px;
            margin-top: 50px;
        }

        .footer-widgets-wrap {
            max-width: 1500px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 40px;
        }

        .footer a {
            color: #ddd;
        }

        .footer a:hover {
            color: white;
        }

        #sub-footer-wrapper {
            background: #131921;
            padding: 20px;
            text-align: center;
            color: #ddd;
        }

        .back-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #232f3e;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            display: none;
            transition: all 0.3s;
            z-index: 99;
        }

        .back-top:hover {
            background: #f08804;
        }

        @media (max-width: 1024px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
            .search-main {
                flex-direction: column;
            }
            .search-button {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .results-header {
                flex-direction: column;
                align-items: stretch;
            }
            .results-sort {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="outer-wrapper">
        <!-- HEADER -->
        <div id="header-wrap">
            <div class="header-header">
                <div class="container row">
                    <div class="header-logo">
                        <a href="/">
                            <img src="http://imgfz.com/i/oXOfVlT.png" alt="CUBAZON" style="height: 100px;">
                        </a>
                    </div>
                    <div class="header-right">
                        <div class="top-bar-social">
                            <ul>
                                <li><a href="#"><i class="fa fa-facebook"></i></a></li>
                                <li><a href="#"><i class="fa fa-instagram"></i></a></li>
                                <li><a href="#"><i class="fa fa-twitter"></i></a></li>
                            </ul>
                        </div>
                        <div class="right-menu">
                            <ul>
                                <li><a href="#"><i class="fa fa-phone"></i> +53 56940021</a></li>
                                <li><a href="#"><i class="fa fa-envelope"></i> soporte@cubazon.com</a></li>
                            </ul>
                        </div>
                        <div class="sora-cart">
                            <div class="sora-cart-details">
                                <span class="simpleCart_quantity" id="cart-counter">0</span>
                            </div>
                            <div class="sora-cart-description">
                                <div class="simpleCart_items" id="cart-preview">
                                    <p style="padding: 20px; text-align: center; color: #666;">Tu carrito está vacío</p>
                                </div>
                                <div class="sora-cart-buttons-wrap">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                                        <button onclick="window.cart.vaciar()" style="background: none; border: none; color: #0f1111; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px;">
                                            <i class="fa fa-trash"></i> Vaciar todo
                                        </button>
                                        <a href="/p/checkout.html" style="background: #ffd814; padding: 8px 20px; border-radius: 20px; color: #0f1111; font-weight: 600; text-decoration: none;">
                                            <i class="fa fa-lock"></i> Pagar
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-menu">
                <div class="container row">
                    <div id="main-menu">
                        <ul>
                            <li><a href="/">Inicio</a></li>
                            <li><a href="/categoria.html?cat=ofertas">Ofertas</a></li>
                            <li><a href="/categoria.html?cat=Electrónica">Electrónica</a></li>
                            <li><a href="/categoria.html?cat=Ropa">Ropa</a></li>
                            <li><a href="/categoria.html?cat=Hogar">Hogar</a></li>
                            <li><a href="/categoria.html?cat=Accesorios">Accesorios</a></li>
                            <li><a href="/p/cart.html">Mi Carrito</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL -->
        <div class="search-container">
            <div id="searchContent">
                <!-- LOADING -->
                <div id="loadingContainer" class="loading-container">
                    <i class="fa fa-spinner fa-pulse"></i>
                    <h2>Cargando buscador...</h2>
                    <p>Por favor espera</p>
                </div>
                
                <!-- CONTENIDO DINÁMICO -->
                <div id="searchApp" style="display: none;"></div>
            </div>
        </div>

        <!-- FOOTER -->
        <div id="footer-wrapper">
            <div class="footer-widgets-wrap">
                <div class="footer">
                    <h3 style="color: white; margin-bottom: 20px;">CUBAZON</h3>
                    <p style="color: #ddd; margin-bottom: 15px;">Tu tienda online de confianza en Sagua de Tánamo.</p>
                    <p style="color: #ddd;"><i class="fa fa-map-marker"></i> Sagua de Tánamo, Holguín, Cuba</p>
                </div>
                <div class="footer">
                    <h3 style="color: white; margin-bottom: 20px;">Enlaces rápidos</h3>
                    <ul style="list-style: none;">
                        <li style="margin-bottom: 10px;"><a href="#">Sobre nosotros</a></li>
                        <li style="margin-bottom: 10px;"><a href="#">Términos y condiciones</a></li>
                        <li style="margin-bottom: 10px;"><a href="#">Política de envíos</a></li>
                        <li style="margin-bottom: 10px;"><a href="#">Contacto</a></li>
                        <li style="margin-bottom: 10px;"><a href="/buscar.html">Búsqueda avanzada</a></li>
                    </ul>
                </div>
                <div class="footer">
                    <h3 style="color: white; margin-bottom: 20px;">Atención al cliente</h3>
                    <p style="color: #ddd; margin-bottom: 10px;"><i class="fa fa-phone"></i> +53 56940021</p>
                    <p style="color: #ddd; margin-bottom: 10px;"><i class="fa fa-envelope"></i> soporte@cubazon.com</p>
                    <p style="color: #ddd;"><i class="fa fa-whatsapp"></i> +53 56940021</p>
                </div>
            </div>
        </div>
        <div id="sub-footer-wrapper">
            <div class="container row">
                <p>@Copyright 2026 CUBAZON · Diseñado por Des.Joshua_Technology · Todos los derechos reservados</p>
            </div>
        </div>

        <div class="back-top" title="Volver arriba">
            <i class="fa fa-chevron-up"></i>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script type="module">
        // ============================================
        // BUSCADOR AVANZADO - VERSIÓN PROFESIONAL
        // COMPLETADO: ✅
        // ============================================
        
        import { supabase } from '/js/supabase-client.js'
        import { initCarrito } from '/js/cart.js'
        
        const carrito = initCarrito()
        window.cart = carrito
        carrito.cargarDeLocalStorage()
        carrito.actualizarInterfaz()

        // ========== ESTADO GLOBAL ==========
        let todosLosProductos = []
        let productosFiltrados = []
        let categoriasData = {}
        let etiquetasData = {}
        
        let terminoBusqueda = ''
        let filtrosActivos = {
            precio: { min: 0, max: 1000 },
            categorias: [],
            etiquetas: [],
            soloOfertas: false,
            soloStock: false,
            rating: 0,
            orden: 'relevancia'
        }
        
        let paginaActual = 1
        const PRODUCTOS_POR_PAGINA = 12
        let tiempoInicioBusqueda = 0

        // ========== INICIALIZAR BUSCADOR ==========
        async function initBuscador() {
            try {
                // Obtener término de búsqueda de la URL
                const urlParams = new URLSearchParams(window.location.search)
                terminoBusqueda = urlParams.get('q') || ''
                
                // Cargar todos los productos
                const { data, error } = await supabase
                    .from('productos')
                    .select('*')
                
                if (error) throw error
                
                todosLosProductos = data || []
                
                // Procesar categorías y etiquetas
                procesarDatos()
                
                // Ocultar loading, mostrar buscador
                document.getElementById('loadingContainer').style.display = 'none'
                document.getElementById('searchApp').style.display = 'block'
                
                // Renderizar interfaz
                renderizarBuscador()
                
                // Si hay término de búsqueda, ejecutar búsqueda automática
                if (terminoBusqueda) {
                    document.getElementById('searchInput').value = terminoBusqueda
                    ejecutarBusqueda()
                }
                
            } catch (error) {
                console.error('Error inicializando buscador:', error)
                document.getElementById('loadingContainer').innerHTML = `
                    <i class="fa fa-exclamation-triangle" style="color: #dc3545;"></i>
                    <h2>Error al cargar</h2>
                    <p>No se pudo cargar el buscador. Intenta de nuevo.</p>
                    <a href="/" class="btn" style="margin-top: 20px;">Volver al inicio</a>
                `
            }
        }

        // ========== PROCESAR DATOS ==========
        function procesarDatos() {
            // Contar productos por categoría
            categoriasData = {}
            todosLosProductos.forEach(p => {
                if (p.etiquetas) {
                    p.etiquetas.forEach(et => {
                        if (!categoriasData[et]) {
                            categoriasData[et] = 0
                        }
                        categoriasData[et]++
                    })
                }
            })
            
            // Contar productos por etiqueta
            etiquetasData = {...categoriasData}
        }

        // ========== RENDERIZAR BUSCADOR ==========
        function renderizarBuscador() {
            const container = document.getElementById('searchApp')
            
            const categoriasOrdenadas = Object.keys(categoriasData)
                .sort()
                .map(cat => ({ nombre: cat, count: categoriasData[cat] }))
                .slice(0, 15)
            
            const etiquetasOrdenadas = Object.keys(etiquetasData)
                .sort((a, b) => etiquetasData[b] - etiquetasData[a])
                .slice(0, 20)
            
            container.innerHTML = `
                <!-- HEADER DE BÚSQUEDA -->
                <div class="search-header">
                    <div class="search-title">
                        <i class="fa fa-search"></i>
                        Búsqueda avanzada
                    </div>
                    
                    <div class="search-main">
                        <div class="search-input-wrapper">
                            <input type="text" 
                                   id="searchInput" 
                                   class="search-input" 
                                   placeholder="¿Qué estás buscando? Ej: camisa, zapatos, electrónica..."
                                   value="${terminoBusqueda}"
                                   autofocus>
                        </div>
                        <button class="search-button" id="searchButton">
                            <i class="fa fa-search"></i>
                            Buscar
                        </button>
                    </div>
                </div>
                
                <!-- FILTROS Y RESULTADOS -->
                <div class="filters-grid">
                    <!-- SIDEBAR DE FILTROS -->
                    <div class="filters-sidebar">
                        <div class="filters-title">
                            <span><i class="fa fa-sliders"></i> Filtros</span>
                            <span id="activeFiltersCount" style="background: #f08804; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">0</span>
                        </div>
                        
                        <!-- FILTRO DE PRECIO -->
                        <div class="filter-group">
                            <h4><i class="fa fa-dollar"></i> Rango de precio</h4>
                            <div class="price-range">
                                <div id="priceSlider"></div>
                                <div class="price-inputs">
                                    <input type="number" id="minPrice" class="price-input" placeholder="Mín" value="0" min="0">
                                    <span style="color: #6c757d;">-</span>
                                    <input type="number" id="maxPrice" class="price-input" placeholder="Máx" value="1000" min="0">
                                </div>
                            </div>
                        </div>
                        
                        <!-- FILTRO DE CATEGORÍAS -->
                        <div class="filter-group">
                            <h4><i class="fa fa-folder"></i> Categorías</h4>
                            <div id="categoriasList">
                                ${categoriasOrdenadas.map(cat => `
                                    <div class="filter-option">
                                        <input type="checkbox" id="cat_${cat.nombre}" value="${cat.nombre}">
                                        <label for="cat_${cat.nombre}">${cat.nombre}</label>
                                        <span class="filter-count">(${cat.count})</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- FILTRO DE OFERTAS Y STOCK -->
                        <div class="filter-group">
                            <h4><i class="fa fa-tag"></i> Estado</h4>
                            <div class="filter-option">
                                <input type="checkbox" id="filterOfertas">
                                <label for="filterOfertas">Solo ofertas</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="filterStock">
                                <label for="filterStock">Solo en stock</label>
                            </div>
                        </div>
                        
                        <!-- FILTRO DE VALORACIÓN -->
                        <div class="filter-group">
                            <h4><i class="fa fa-star"></i> Valoración mínima</h4>
                            <div class="filter-option">
                                <input type="radio" name="rating" value="0" id="rating0" checked>
                                <label for="rating0">Cualquiera</label>
                            </div>
                            <div class="filter-option">
                                <input type="radio" name="rating" value="4" id="rating4">
                                <label for="rating4">4 estrellas +</label>
                            </div>
                            <div class="filter-option">
                                <input type="radio" name="rating" value="3" id="rating3">
                                <label for="rating3">3 estrellas +</label>
                            </div>
                        </div>
                        
                        <!-- ETIQUETAS POPULARES -->
                        <div class="filter-group">
                            <h4><i class="fa fa-tags"></i> Etiquetas populares</h4>
                            <div class="tags-cloud">
                                ${etiquetasOrdenadas.map(et => `
                                    <span class="tag-item" data-tag="${et}">${et}</span>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- BOTONES DE ACCIÓN -->
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button id="applyFiltersBtn" class="search-button" style="flex: 1; padding: 12px;">
                                <i class="fa fa-check"></i> Aplicar filtros
                            </button>
                            <button id="clearFiltersBtn" class="btn" style="flex: 0 0 50px; padding: 12px; background: #f0f2f5;">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- RESULTADOS DE BÚSQUEDA -->
                    <div>
                        <div id="resultsHeader" style="display: none;">
                            <!-- Los resultados se renderizan aquí -->
                        </div>
                        
                        <div id="resultsContainer"></div>
                        
                        <div id="paginationContainer"></div>
                    </div>
                </div>
            `
            
            // Inicializar componentes después de renderizar
            setTimeout(() => {
                initPriceSlider()
                initEventListeners()
                
                // Si hay término de búsqueda, cargar resultados
                if (terminoBusqueda) {
                    ejecutarBusqueda()
                }
            }, 100)
        }

        // ========== INICIALIZAR SLIDER DE PRECIO ==========
        function initPriceSlider() {
            const slider = document.getElementById('priceSlider')
            if (!slider) return
            
            if (slider.noUiSlider) {
                slider.noUiSlider.destroy()
            }
            
            noUiSlider.create(slider, {
                start: [filtrosActivos.precio.min, filtrosActivos.precio.max],
                connect: true,
                range: {
                    'min': 0,
                    'max': 1000
                },
                step: 1,
                format: {
                    to: value => Math.round(value),
                    from: value => Math.round(value)
                }
            })
            
            slider.noUiSlider.on('update', function(values) {
                document.getElementById('minPrice').value = values[0]
                document.getElementById('maxPrice').value = values[1]
            })
            
            slider.noUiSlider.on('change', function(values) {
                filtrosActivos.precio.min = parseInt(values[0])
                filtrosActivos.precio.max = parseInt(values[1])
            })
            
            // Eventos para inputs manuales
            document.getElementById('minPrice').addEventListener('change', function() {
                let val = parseInt(this.value) || 0
                if (val < 0) val = 0
                if (val > filtrosActivos.precio.max) val = filtrosActivos.precio.max
                slider.noUiSlider.set([val, null])
            })
            
            document.getElementById('maxPrice').addEventListener('change', function() {
                let val = parseInt(this.value) || 0
                if (val > 1000) val = 1000
                if (val < filtrosActivos.precio.min) val = filtrosActivos.precio.min
                slider.noUiSlider.set([null, val])
            })
        }

        // ========== EJECUTAR BÚSQUEDA ==========
        function ejecutarBusqueda() {
            tiempoInicioBusqueda = performance.now()
            
            // Obtener término de búsqueda
            terminoBusqueda = document.getElementById('searchInput')?.value || ''
            
            // Actualizar URL
            const url = new URL(window.location)
            if (terminoBusqueda) {
                url.searchParams.set('q', terminoBusqueda)
            } else {
                url.searchParams.delete('q')
            }
            window.history.pushState({}, '', url)
            
            // Filtrar productos
            filtrarProductos()
        }

        // ========== FILTRAR PRODUCTOS ==========
        function filtrarProductos() {
            let resultados = [...todosLosProductos]
            
            // Filtro por término de búsqueda
            if (terminoBusqueda) {
                const termino = terminoBusqueda.toLowerCase()
                resultados = resultados.filter(p => 
                    p.nombre.toLowerCase().includes(termino) ||
                    (p.descripcion && p.descripcion.toLowerCase().includes(termino)) ||
                    (p.etiquetas && p.etiquetas.some(e => e.toLowerCase().includes(termino))) ||
                    (p.slug && p.slug.toLowerCase().includes(termino))
                )
            }
            
            // Filtro por precio
            resultados = resultados.filter(p => 
                p.precio >= filtrosActivos.precio.min && 
                p.precio <= filtrosActivos.precio.max
            )
            
            // Filtro por categorías
            if (filtrosActivos.categorias.length > 0) {
                resultados = resultados.filter(p => 
                    p.etiquetas && filtrosActivos.categorias.some(c => p.etiquetas.includes(c))
                )
            }
            
            // Filtro por etiquetas
            if (filtrosActivos.etiquetas.length > 0) {
                resultados = resultados.filter(p => 
                    p.etiquetas && filtrosActivos.etiquetas.some(e => p.etiquetas.includes(e))
                )
            }
            
            // Filtro solo ofertas
            if (filtrosActivos.soloOfertas) {
                resultados = resultados.filter(p => p.oferta === true)
            }
            
            // Filtro solo stock
            if (filtrosActivos.soloStock) {
                resultados = resultados.filter(p => p.stock > 0)
            }
            
            // Filtro por rating (simulado)
            if (filtrosActivos.rating > 0) {
                // Simular rating - en una implementación real, vendría de la BD
                resultados = resultados.filter(() => Math.random() > 0.3)
            }
            
            // Ordenamiento
            switch(filtrosActivos.orden) {
                case 'menor-precio':
                    resultados.sort((a, b) => a.precio - b.precio)
                    break
                case 'mayor-precio':
                    resultados.sort((a, b) => b.precio - a.precio)
                    break
                case 'nombre':
                    resultados.sort((a, b) => a.nombre.localeCompare(b.nombre))
                    break
                case 'descuento':
                    resultados.sort((a, b) => (b.oferta ? 1 : 0) - (a.oferta ? 1 : 0))
                    break
                default:
                    // Relevancia: productos que coinciden exactamente con el término primero
                    if (terminoBusqueda) {
                        resultados.sort((a, b) => {
                            const aExact = a.nombre.toLowerCase() === terminoBusqueda.toLowerCase() ? 1 : 0
                            const bExact = b.nombre.toLowerCase() === terminoBusqueda.toLowerCase() ? 1 : 0
                            return bExact - aExact
                        })
                    }
            }
            
            productosFiltrados = resultados
            paginaActual = 1
            renderizarResultados()
            actualizarContadorFiltros()
        }

        // ========== RENDERIZAR RESULTADOS ==========
        function renderizarResultados() {
            const container = document.getElementById('resultsContainer')
            const headerContainer = document.getElementById('resultsHeader')
            const paginationContainer = document.getElementById('paginationContainer')
            
            const tiempoEjecucion = ((performance.now() - tiempoInicioBusqueda) / 1000).toFixed(2)
            
            // Header de resultados
            headerContainer.style.display = 'block'
            headerContainer.innerHTML = `
                <div class="results-header">
                    <div class="results-stats">
                        <span class="results-count">
                            <i class="fa fa-cube"></i> ${productosFiltrados.length} productos encontrados
                        </span>
                        ${terminoBusqueda ? `
                            <span class="results-time">
                                para "${terminoBusqueda}" en ${tiempoEjecucion}s
                            </span>
                        ` : ''}
                    </div>
                    <select id="sortSelect" class="results-sort">
                        <option value="relevancia" ${filtrosActivos.orden === 'relevancia' ? 'selected' : ''}>Relevancia</option>
                        <option value="menor-precio" ${filtrosActivos.orden === 'menor-precio' ? 'selected' : ''}>Menor precio</option>
                        <option value="mayor-precio" ${filtrosActivos.orden === 'mayor-precio' ? 'selected' : ''}>Mayor precio</option>
                        <option value="nombre" ${filtrosActivos.orden === 'nombre' ? 'selected' : ''}>Nombre</option>
                        <option value="descuento" ${filtrosActivos.orden === 'descuento' ? 'selected' : ''}>Mayor descuento</option>
                    </select>
                </div>
                
                <div id="activeFiltersContainer" class="active-filters"></div>
            `
            
            // Renderizar filtros activos
            renderizarFiltrosActivos()
            
            // Paginación
            const start = (paginaActual - 1) * PRODUCTOS_POR_PAGINA
            const end = start + PRODUCTOS_POR_PAGINA
            const productosPagina = productosFiltrados.slice(start, end)
            const totalPaginas = Math.ceil(productosFiltrados.length / PRODUCTOS_POR_PAGINA)
            
            // Grid de productos
            if (productosPagina.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <i class="fa fa-search"></i>
                        <h2>No hay resultados</h2>
                        <p>No encontramos productos que coincidan con tu búsqueda.</p>
                        <button onclick="window.limpiarTodo()" class="btn">
                            Limpiar búsqueda
                        </button>
                    </div>
                `
                paginationContainer.innerHTML = ''
                return
            }
            
            let productosHtml = '<div class="products-grid">'
            
            productosPagina.forEach(p => {
                const precioOferta = p.oferta && p.precio_oferta ? p.precio_oferta : null
                const precioActual = precioOferta || p.precio
                const descuento = p.oferta && p.precio_oferta 
                    ? Math.round(((p.precio - p.precio_oferta) / p.precio) * 100) 
                    : 0
                
                let stockClass = 'stock-available'
                let stockIcon = 'fa-check-circle'
                let stockText = `${p.stock} disponibles`
                
                if (p.stock <= 0) {
                    stockClass = 'stock-out'
                    stockIcon = 'fa-ban'
                    stockText = 'AGOTADO'
                } else if (p.stock <= 5) {
                    stockClass = 'stock-low'
                    stockIcon = 'fa-exclamation-triangle'
                    stockText = `¡Últimos ${p.stock}!`
                }
                
                if (p.stock <= 0) {
                    productosHtml += `
                        <div class="product-card">
                            <a href="/producto.html?id=${p.id}">
                                <img src="${p.imagen || 'https://via.placeholder.com/300'}" class="product-image" alt="${p.nombre}">
                                <h3 class="product-title">${p.nombre}</h3>
                            </a>
                            <div class="product-rating">
                                <i class="fa fa-star"></i>
                                <i class="fa fa-star"></i>
                                <i class="fa fa-star"></i>
                                <i class="fa fa-star"></i>
                                <i class="fa fa-star-half-o"></i>
                            </div>
                            <div class="product-agotado">
                                <i class="fa fa-ban"></i> AGOTADO
                            </div>
                        </div>
                    `
                } else {
                    productosHtml += `
                        <div class="product-card">
                            <a href="/producto.html?id=${p.id}">
                                <img src="${p.imagen || 'https://via.placeholder.com/300'}" class="product-image" alt="${p.nombre}">
                                <h3 class="product-title">${p.nombre}</h3>
                            </a>
                            <div class="product-rating">
                                <i class="fa fa-star"></i>
                                <i class="fa fa-star"></i>
                                <i class="fa fa-star"></i>
                                <i class="fa fa-star"></i>
                                <i class="fa fa-star-half-o"></i>
                            </div>
                            <div class="product-price">
                                $${precioActual.toFixed(2)} <small>CUP</small>
                                ${precioOferta ? `<span class="product-original-price">$${p.precio.toFixed(2)}</span>` : ''}
                                ${descuento > 0 ? `<span class="product-discount">-${descuento}%</span>` : ''}
                            </div>
                            <div class="product-stock ${stockClass}">
                                <i class="fa ${stockIcon}"></i> ${stockText}
                            </div>
                            <button class="btn-add-cart" onclick="window.cart.agregar(${p.id}, 1)">
                                <i class="fa fa-shopping-cart"></i> Agregar
                            </button>
                        </div>
                    `
                }
            })
            
            productosHtml += '</div>'
            container.innerHTML = productosHtml
            
            // Paginación
            if (totalPaginas > 1) {
                let paginacionHtml = '<div class="pagination">'
                
                // Anterior
                paginacionHtml += `
                    <div class="pagination-item ${paginaActual === 1 ? 'disabled' : ''}" 
                         onclick="${paginaActual > 1 ? 'window.cambiarPagina(' + (paginaActual - 1) + ')' : ''}">
                        <i class="fa fa-chevron-left"></i>
                    </div>
                `
                
                // Números
                for (let i = 1; i <= totalPaginas; i++) {
                    if (i === 1 || i === totalPaginas || (i >= paginaActual - 2 && i <= paginaActual + 2)) {
                        paginacionHtml += `
                            <div class="pagination-item ${i === paginaActual ? 'active' : ''}" 
                                 onclick="window.cambiarPagina(${i})">
                                ${i}
                            </div>
                        `
                    } else if (i === paginaActual - 3 || i === paginaActual + 3) {
                        paginacionHtml += `<div class="pagination-item disabled">...</div>`
                    }
                }
                
                // Siguiente
                paginacionHtml += `
                    <div class="pagination-item ${paginaActual === totalPaginas ? 'disabled' : ''}" 
                         onclick="${paginaActual < totalPaginas ? 'window.cambiarPagina(' + (paginaActual + 1) + ')' : ''}">
                        <i class="fa fa-chevron-right"></i>
                    </div>
                `
                
                paginacionHtml += '</div>'
                paginationContainer.innerHTML = paginacionHtml
            } else {
                paginationContainer.innerHTML = ''
            }
            
            // Event listener para ordenamiento
            document.getElementById('sortSelect')?.addEventListener('change', function(e) {
                filtrosActivos.orden = e.target.value
                filtrarProductos()
            })
        }

        // ========== RENDERIZAR FILTROS ACTIVOS ==========
        function renderizarFiltrosActivos() {
            const container = document.getElementById('activeFiltersContainer')
            if (!container) return
            
            let html = ''
            let totalActivos = 0
            
            if (terminoBusqueda) {
                html += `<span class="filter-tag">
                    <i class="fa fa-search"></i> "${terminoBusqueda}"
                    <i class="fa fa-times" onclick="window.limpiarBusqueda()"></i>
                </span>`
                totalActivos++
            }
            
            if (filtrosActivos.categorias.length > 0) {
                filtrosActivos.categorias.forEach(cat => {
                    html += `<span class="filter-tag">
                        ${cat}
                        <i class="fa fa-times" onclick="window.removerCategoria('${cat}')"></i>
                    </span>`
                    totalActivos++
                })
            }
            
            if (filtrosActivos.etiquetas.length > 0) {
                filtrosActivos.etiquetas.forEach(et => {
                    html += `<span class="filter-tag">
                        ${et}
                        <i class="fa fa-times" onclick="window.removerEtiqueta('${et}')"></i>
                    </span>`
                    totalActivos++
                })
            }
            
            if (filtrosActivos.soloOfertas) {
                html += `<span class="filter-tag">
                    Solo ofertas
                    <i class="fa fa-times" onclick="window.toggleOfertas()"></i>
                </span>`
                totalActivos++
            }
            
            if (filtrosActivos.soloStock) {
                html += `<span class="filter-tag">
                    Solo en stock
                    <i class="fa fa-times" onclick="window.toggleStock()"></i>
                </span>`
                totalActivos++
            }
            
            if (filtrosActivos.precio.min > 0 || filtrosActivos.precio.max < 1000) {
                html += `<span class="filter-tag">
                    $${filtrosActivos.precio.min} - $${filtrosActivos.precio.max}
                    <i class="fa fa-times" onclick="window.limpiarPrecio()"></i>
                </span>`
                totalActivos++
            }
            
            if (totalActivos > 0) {
                html += `<button class="clear-filters" onclick="window.limpiarTodo()">
                    Limpiar todo
                </button>`
            }
            
            container.innerHTML = html
            document.getElementById('activeFiltersCount').textContent = totalActivos
        }

        // ========== ACTUALIZAR CONTADOR DE FILTROS ==========
        function actualizarContadorFiltros() {
            let total = 0
            if (filtrosActivos.categorias.length > 0) total += filtrosActivos.categorias.length
            if (filtrosActivos.etiquetas.length > 0) total += filtrosActivos.etiquetas.length
            if (filtrosActivos.soloOfertas) total++
            if (filtrosActivos.soloStock) total++
            if (filtrosActivos.precio.min > 0 || filtrosActivos.precio.max < 1000) total++
            document.getElementById('activeFiltersCount').textContent = total
        }

        // ========== FUNCIONES GLOBALES ==========
        window.cambiarPagina = function(pagina) {
            paginaActual = pagina
            renderizarResultados()
            window.scrollTo({ top: 0, behavior: 'smooth' })
        }

        window.limpiarBusqueda = function() {
            terminoBusqueda = ''
            document.getElementById('searchInput').value = ''
            const url = new URL(window.location)
            url.searchParams.delete('q')
            window.history.pushState({}, '', url)
            filtrarProductos()
        }

        window.removerCategoria = function(cat) {
            filtrosActivos.categorias = filtrosActivos.categorias.filter(c => c !== cat)
            document.getElementById(`cat_${cat}`).checked = false
            filtrarProductos()
        }

        window.removerEtiqueta = function(et) {
            filtrosActivos.etiquetas = filtrosActivos.etiquetas.filter(e => e !== et)
            filtrarProductos()
        }

        window.toggleOfertas = function() {
            filtrosActivos.soloOfertas = false
            document.getElementById('filterOfertas').checked = false
            filtrarProductos()
        }

        window.toggleStock = function() {
            filtrosActivos.soloStock = false
            document.getElementById('filterStock').checked = false
            filtrarProductos()
        }

        window.limpiarPrecio = function() {
            filtrosActivos.precio = { min: 0, max: 1000 }
            const slider = document.getElementById('priceSlider')
            if (slider && slider.noUiSlider) {
                slider.noUiSlider.set([0, 1000])
            }
            filtrarProductos()
        }

        window.limpiarTodo = function() {
            terminoBusqueda = ''
            document.getElementById('searchInput').value = ''
            
            filtrosActivos = {
                precio: { min: 0, max: 1000 },
                categorias: [],
                etiquetas: [],
                soloOfertas: false,
                soloStock: false,
                rating: 0,
                orden: 'relevancia'
            }
            
            // Resetear checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false)
            document.querySelectorAll('input[type="radio"]').forEach(r => {
                if (r.value === '0') r.checked = true
            })
            
            // Resetear slider
            const slider = document.getElementById('priceSlider')
            if (slider && slider.noUiSlider) {
                slider.noUiSlider.set([0, 1000])
            }
            
            // Limpiar URL
            const url = new URL(window.location)
            url.searchParams.delete('q')
            window.history.pushState({}, '', url)
            
            filtrarProductos()
        }

        // ========== INICIALIZAR EVENT LISTENERS ==========
        function initEventListeners() {
            // Botón de búsqueda
            document.getElementById('searchButton').addEventListener('click', ejecutarBusqueda)
            
            // Enter en el input
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    ejecutarBusqueda()
                }
            })
            
            // Aplicar filtros
            document.getElementById('applyFiltersBtn').addEventListener('click', function() {
                // Obtener categorías seleccionadas
                filtrosActivos.categorias = []
                document.querySelectorAll('#categoriasList input[type="checkbox"]:checked').forEach(cb => {
                    filtrosActivos.categorias.push(cb.value)
                })
                
                // Obtener ofertas y stock
                filtrosActivos.soloOfertas = document.getElementById('filterOfertas').checked
                filtrosActivos.soloStock = document.getElementById('filterStock').checked
                
                // Obtener rating
                const ratingSelected = document.querySelector('input[name="rating"]:checked')
                filtrosActivos.rating = parseInt(ratingSelected?.value || '0')
                
                filtrarProductos()
            })
            
            // Limpiar filtros
            document.getElementById('clearFiltersBtn').addEventListener('click', window.limpiarTodo)
            
            // Click en etiquetas
            document.querySelectorAll('.tag-item').forEach(tag => {
                tag.addEventListener('click', function() {
                    const etiqueta = this.dataset.tag
                    if (!filtrosActivos.etiquetas.includes(etiqueta)) {
                        filtrosActivos.etiquetas.push(etiqueta)
                        this.classList.add('active')
                        filtrarProductos()
                    }
                })
            })
        }

        // ========== INICIAR ==========
        initBuscador()

        // Back to top
        window.addEventListener('scroll', function() {
            const backTop = document.querySelector('.back-top')
            backTop.style.display = window.scrollY > 300 ? 'flex' : 'none'
        })
        
        document.querySelector('.back-top')?.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' })
        })
    </script>
</body>
</html>